<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Writing Hub - Cloud Edition</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- TinyMCE Editor -->
<script src="https://cdn.jsdelivr.net/npm/tinymce@6/tinymce.min.js"></script>

<!-- PDF.js for PDF parsing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
    // Configure PDF.js worker
    if (typeof pdfjsLib !== 'undefined') {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
</script>

<!-- Mammoth for Word document parsing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    
    <style>
        :root {
            --primary-color: #667eea;
            --primary-light: #e0e7ff;
            --primary-dark: #5a67d8;
            --secondary-color: #38a169;
            --accent-color: #ed64a6;
            --warning-color: #d69e2e;
            --error-color: #e53e3e;
            --bg-color: #f7fafc;
            --card-bg: #ffffff;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Header */
        .app-header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: var(--primary-light);
            border-radius: 20px;
            cursor: pointer;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-name {
            font-weight: 500;
            font-size: 14px;
        }

        .sign-in-btn {
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sign-in-btn:hover {
            background: var(--primary-dark);
        }

        /* Auth Modal */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .auth-modal.visible {
            display: flex;
        }

        .auth-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .auth-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .auth-subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .google-sign-in-btn {
            width: 100%;
            padding: 14px 20px;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.2s;
        }

        .google-sign-in-btn:hover {
            border-color: var(--primary-color);
            background: var(--primary-light);
        }

        .google-icon {
            width: 20px;
            height: 20px;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
            padding: 4px 12px;
            background: var(--bg-color);
            border-radius: 12px;
        }

        .sync-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--secondary-color);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Dashboard View */
        .dashboard-view {
            max-width: 1400px;
            margin: 0 auto;
            padding: 60px 40px;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 60px;
        }

        .dashboard-title {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .dashboard-subtitle {
            font-size: 18px;
            color: var(--text-secondary);
        }

        .continue-section {
            margin-bottom: 50px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .recent-projects {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .recent-project-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .recent-project-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

        .recent-project-name {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .recent-project-category {
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 10px;
        }

        .recent-project-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 50px;
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }

        .category-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 0;
            overflow: hidden;
            transition: all 0.2s;
        }

        .category-card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        .category-header {
            padding: 25px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
        }

        .category-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .category-description {
            font-size: 14px;
            opacity: 0.9;
        }

        .category-projects {
            padding: 20px 25px;
        }

        .project-item {
            padding: 12px 15px;
            margin: 5px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-item:hover {
            background: var(--bg-color);
        }

        .project-info {
            flex: 1;
        }

        .project-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .project-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Project Workspace View */
        .workspace-view {
    display: none;
    height: 100vh;
    flex-direction: column;
}

        .workspace-header {
    background: var(--card-bg);
    border-bottom: 1px solid var(--border-color);
    padding: 12px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.workspace-title {
    display: flex;
    align-items: center;
    gap: 0;
}

.header-actions {
    display: flex;
    gap: 10px;
    align-items: center;
}

        .workspace-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 20px;
            padding: 5px 10px;
        }

        .back-btn:hover {
            color: var(--primary-color);
        }

        .workspace-content {
    flex: 1;
    display: flex;
    overflow: hidden;
    height: calc(100vh - 60px);
}

        .materials-panel {
    width: 280px;
    background: var(--card-bg);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
}
        .materials-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .materials-header h3 {
            margin-bottom: 15px;
        }

        .materials-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .material-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .material-item:hover {
            border-color: var(--primary-color);
            background: var(--primary-light);
        }

        .material-item.selected {
            border-color: var(--primary-color);
            background: var(--primary-light);
        }

        .material-toggle {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background: white;
            transition: all 0.2s;
        }

        .material-toggle.enabled {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
            color: white;
        }

        .material-toggle.enabled::after {
            content: '‚úì';
            font-size: 14px;
        }

        .material-info {
            flex: 1;
            min-width: 0;
        }

        .material-name {
    font-weight: 500;
    margin-bottom: 2px;
    white-space: normal;
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.3;
    cursor: text;
    padding: 2px 4px;
    border-radius: 3px;
    /* Remove the hover background that was causing the shadow */
}

.material-name.editing {
    background: white;
    border: 1px solid var(--primary-color);
    outline: none;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
}

        .material-name.editing {
            background: white;
            border: 1px solid var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .material-type {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .material-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .delete-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s;
            opacity: 0;
        }

        .material-item:hover .delete-btn {
            opacity: 1;
        }

        .delete-btn:hover {
            background: var(--error-color);
            color: white;
        }

        .editor-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--bg-color);
    min-width: 0;
}

        .editor-content {
    flex: 1;
    overflow-y: auto;
    background: white;
    padding: 0;
    height: 100%;
}

       .editor-card {
    background: white;
    padding: 40px 80px;
    max-width: none;
    margin: 0 auto;
    height: 100%;
    width: 100%;
}
        
        /* TinyMCE Editor Customization */
.tox-tinymce {
    border: 1px solid var(--border-color) !important;
    border-radius: 8px;
}

.tox .tox-edit-area {
    padding: 20px;
}

.tox .tox-toolbar {
    background: white !important;
    border-bottom: 1px solid var(--border-color) !important;
}

        /* Fix TinyMCE fullscreen button */
.tox .tox-tbtn {
    cursor: pointer;
}

.tox-fullscreen {
    z-index: 10000 !important;
}

.tox-fullscreen .tox-toolbar,
.tox-fullscreen .tox-edit-area {
    background: white !important;
}
        
        /* AI Response Box */
        .ai-response-container {
            margin-top: 20px;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            background: var(--primary-light);
            padding: 20px;
            display: none;
        }

        .ai-response-container.visible {
            display: block;
        }

        .ai-response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--primary-color);
        }

        .ai-response-title {
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-response-actions {
            display: flex;
            gap: 8px;
        }

        .ai-response-content {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            min-height: 100px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: inherit;
            font-size: 15px;
            line-height: 1.7;
            margin-bottom: 15px;
        }

        .ai-response-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .ai-response-controls .btn {
            padding: 8px 16px;
            font-size: 13px;
        }

        .ai-panel {
    width: 320px;
    flex-shrink: 0;
    background: var(--card-bg);
    border-left: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    max-height: 100vh;
}

        .ai-panel-tabs {
    display: flex;
    border-bottom: 1px solid var(--border-color);
    background: #f8f9fa;
}

.ai-panel-tab {
    flex: 1;
    padding: 15px 20px;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    font-weight: 500;
    color: var(--text-secondary);
    transition: all 0.2s;
}

.ai-panel-tab:hover {
    color: var(--primary-color);
    background: rgba(102, 126, 234, 0.05);
}

.ai-panel-tab.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
    background: white;
}

.ai-panel-view {
    display: none;
    flex-direction: column;
    flex: 1;
    overflow: hidden;
}

.ai-panel-view.active {
    display: flex;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.chat-message {
    padding: 12px 16px;
    border-radius: 12px;
    max-width: 85%;
    word-wrap: break-word;
    line-height: 1.5;
    font-size: 14px;
}

.chat-message.user {
    background: var(--primary-color);
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
}

.chat-message.assistant {
    background: #f0f0f0;
    color: var(--text-primary);
    align-self: flex-start;
    border-bottom-left-radius: 4px;
}

.chat-message.system {
    background: var(--primary-light);
    color: var(--text-secondary);
    align-self: center;
    font-size: 12px;
    font-style: italic;
    max-width: 90%;
    text-align: center;
}

.chat-input-area {
    border-top: 1px solid var(--border-color);
    padding: 15px 20px;
    background: white;
}

.chat-input-wrapper {
    display: flex;
    gap: 10px;
    align-items: flex-end;
}

.chat-input {
    flex: 1;
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
    min-height: 40px;
    max-height: 120px;
}

.chat-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.chat-send-btn {
    padding: 10px 16px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.2s;
}

.chat-send-btn:hover:not(:disabled) {
    background: var(--primary-dark);
}

.chat-send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.chat-context-info {
    font-size: 11px;
    color: var(--text-secondary);
    margin-bottom: 8px;
    padding: 8px;
    background: var(--bg-color);
    border-radius: 4px;
}

        /* Chat Sidebar */
.chat-sidebar {
    width: 250px;
    background: var(--bg-color);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
}

.chat-sidebar-header {
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
}

.chat-sidebar-title {
    font-weight: 600;
    font-size: 14px;
}

.chat-list {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}

.chat-list-item {
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 8px;
    overflow: hidden;
    transition: all 0.2s;
}

.chat-list-item:hover {
    border-color: var(--primary-color);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
}

.chat-list-item.active {
    border-color: var(--primary-color);
    background: var(--primary-light);
}

.chat-list-main {
    padding: 12px;
    cursor: pointer;
}

.chat-list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.chat-list-name {
    font-weight: 500;
    font-size: 14px;
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.chat-list-count {
    font-size: 11px;
    color: var(--text-secondary);
    background: var(--bg-color);
    padding: 2px 6px;
    border-radius: 10px;
    margin-left: 8px;
}

.chat-list-meta {
    font-size: 11px;
    color: var(--text-secondary);
}

.chat-list-actions {
    display: flex;
    gap: 4px;
    padding: 8px 12px;
    border-top: 1px solid var(--border-color);
    background: var(--bg-color);
    opacity: 0;
    transition: opacity 0.2s;
}

.chat-list-item:hover .chat-list-actions {
    opacity: 1;
}

.chat-header-title {
    font-weight: 600;
    font-size: 16px;
}

.chat-message-actions {
    display: flex;
    gap: 6px;
    margin-top: 8px;
    opacity: 0;
    transition: opacity 0.2s;
}

.chat-message:hover .chat-message-actions {
    opacity: 1;
}
        
.chat-empty {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--text-secondary);
    padding: 40px 20px;
    text-align: center;
}

.chat-empty-icon {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.5;
}

.chat-actions {
    display: flex;
    gap: 8px;
    margin-top: 8px;
}

        .ai-panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: #f8f9fa;
        }

        .ai-panel-content {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        /* Agent Selector */
        .agent-selector {
            margin-bottom: 20px;
            padding: 15px;
            background: var(--primary-light);
            border-radius: 8px;
            border: 1px solid var(--primary-color);
        }

        .agent-selector-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--primary-dark);
            margin-bottom: 8px;
            display: block;
        }

        .agent-select-wrapper {
            display: flex;
            gap: 8px;
        }

        .agent-select {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--primary-color);
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            background: white;
        }

        .agent-info-box {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .agent-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .agent-info-label {
            font-weight: 500;
            color: var(--text-primary);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background: #2f855a;
        }

        .btn-outline {
            background: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-danger {
            background: var(--error-color);
            color: white;
        }

        .btn-danger:hover {
            background: #c53030;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Setting Group */
        .setting-group {
            margin-bottom: 25px;
        }
.font-preview {
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    margin-top: 8px;
    background: white;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
}
        .setting-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .setting-input, .setting-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }

        .setting-input:focus, .setting-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .setting-range {
            width: 100%;
            margin: 10px 0;
        }

        .range-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .range-value {
            text-align: center;
            font-weight: 500;
            color: var(--primary-color);
            margin-top: 5px;
        }

        .setting-help {
    font-size: 11px;
    color: var(--text-secondary);
    margin-top: 5px;
    line-height: 1.4;
}
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-content.large {
            max-width: 900px;
        }

        .modal-header {
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        /* File Upload Area */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: var(--primary-color);
            background: var(--primary-light);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .upload-text {
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .upload-subtext {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* Status Bar */
        .status-bar {
            padding: 10px 20px;
            background: #f8f9fa;
            border-top: 1px solid var(--border-color);
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--error-color);
        }

        .status-dot.connected {
            background: var(--secondary-color);
        }

        /* Prompt Library */
        .prompt-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .prompt-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }

        .prompt-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .prompt-card-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .prompt-card-category {
            font-size: 11px;
            color: var(--text-secondary);
            background: var(--bg-color);
            padding: 2px 8px;
            border-radius: 12px;
        }

        .prompt-card-preview {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .prompt-card-actions {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }

        /* Agent List */
        .agent-list-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .agent-list-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }

        .agent-list-item.default {
            border-color: var(--warning-color);
            background: #fffaf0;
        }

        .agent-list-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .agent-list-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .agent-list-description {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .agent-list-details {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            gap: 15px;
        }

        .agent-list-actions {
            display: flex;
            gap: 6px;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Export Dropdown */
        .export-dropdown {
            position: relative;
            display: inline-block;
        }

        .export-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 5px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 8px 0;
            min-width: 150px;
            z-index: 100;
        }

        .export-menu.show {
            display: block;
        }

        .export-menu-item {
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .export-menu-item:hover {
            background: var(--bg-color);
        }

        /* Context Menu */
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 8px 0;
            z-index: 1000;
            display: none;
        }

        .context-menu-item {
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .context-menu-item:hover {
            background: var(--bg-color);
        }

        .divider {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        /* Model Manager Styles */
        .model-search {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .model-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: var(--primary-color);
        }

        .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .models-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .model-item {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .model-item:hover {
            border-color: var(--primary-color);
            background: var(--primary-light);
        }

        .model-item.hidden {
            opacity: 0.5;
        }

        .model-item.favorite {
            border-color: var(--warning-color);
            background: #fffaf0;
        }

        .model-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .model-name-block {
            flex: 1;
        }

        .model-display-name {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .model-id {
            font-size: 11px;
            color: var(--text-secondary);
            font-family: monospace;
        }

        .model-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: var(--bg-color);
        }

        .model-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .model-detail {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--primary-color);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .ai-panel {
                position: fixed;
                right: -400px;
                top: 0;
                height: 100%;
                z-index: 500;
                transition: right 0.3s;
            }

            .ai-panel.visible {
                right: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Modal -->
    <div class="auth-modal" id="authModal">
        <div class="auth-content">
            <h2 class="auth-title">Welcome to AI Writing Hub</h2>
            <p class="auth-subtitle">Sign in to sync your projects across all devices</p>
            <button class="google-sign-in-btn" onclick="signInWithGoogle()">
                <svg class="google-icon" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- App Header -->
    <div class="app-header">
        <div class="app-logo" style="font-size: 18px;">‚ú® My AI Workspace</div>
        <div class="header-actions">
            <div class="sync-status" id="syncStatus" style="display: none;">
                <div class="sync-dot"></div>
                <span>Synced</span>
            </div>
            <button class="btn btn-outline" onclick="showSettings()">‚öôÔ∏è Settings</button>
            <button class="btn btn-outline" onclick="showAgentManager()">ü§ñ AI Agents</button>
            <button class="btn btn-outline" onclick="showPromptLibrary()">üìö Prompts</button>
            <div id="userProfileContainer"></div>
        </div>
    </div>

    <!-- Dashboard View -->
    <div class="dashboard-view" id="dashboardView">
        <div class="dashboard-header">
            <h1 class="dashboard-title">Your Projects</h1>
            <p class="dashboard-subtitle">Which project do you want to work on today?</p>
        </div>

        <!-- Continue Where You Left Off -->
        <div class="continue-section" id="continueSection">
            <h2 class="section-title">Continue Where You Left Off</h2>
            <div class="recent-projects" id="recentProjects"></div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="showNewCategoryModal()">+ Create Category</button>
            <button class="btn btn-outline" onclick="showNewProjectModal()">+ Create Project</button>
        </div>

        <!-- All Categories & Projects -->
        <h2 class="section-title">All Projects by Category</h2>
        <div class="categories-grid" id="categoriesGrid"></div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-icon">üìÅ</div>
            <h3>No projects yet</h3>
            <p>Create your first category and project to get started</p>
            <button class="btn btn-primary" onclick="showNewCategoryModal()" style="margin-top: 20px;">
                Get Started
            </button>
        </div>
    </div>

    <!-- Workspace View -->
    <div class="workspace-view" id="workspaceView">
        <div class="workspace-content">
            <!-- Materials Panel -->
            <div class="materials-panel">
                <div class="materials-header">
    <button class="back-btn" onclick="returnToDashboard()" style="margin-bottom: 15px; padding: 8px 12px; width: 100%; border-bottom: 1px solid var(--border-color); padding-bottom: 15px;">
    ‚Üê Back to Dashboard
</button>
    
    <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid var(--primary-color);">
        <h2 id="sidebarProjectName" style="font-size: 20px; font-weight: 700; margin-bottom: 3px;">Project Name</h2>
        <p id="sidebarProjectCategory" style="font-size: 12px; color: var(--text-secondary); margin: 0;">Category</p>
    </div>
    
    <h3 style="margin-bottom: 15px; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Materials</h3>
    
    <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="showAddMaterialModal()">
        + Add Material
    </button>
    <button class="btn btn-outline" style="width: 100%; margin-bottom: 15px;" onclick="showUploadModal()">
        üì§ Upload File
    </button>
    
    <div style="text-align: center;">
    <span id="enabledCount" style="display: inline-block; background: var(--secondary-color); color: white; padding: 6px 14px; border-radius: 16px; font-size: 11px; font-weight: 600;">
        ‚úì 0 materials enabled
    </span>
</div>
</div>
                <div class="materials-list" id="materialsList">
                    <div class="empty-state">
                        <div class="empty-icon" style="font-size: 32px;">üìÑ</div>
                        <p>No materials yet</p>
                    </div>
                </div>
            </div>

            <!-- Editor Area -->
            <div class="editor-area">
                
                <div class="editor-content">
                    <div class="editor-card" id="editorCard">
                        <div class="empty-state">
                            <div class="empty-icon" style="font-size: 48px;">‚ú®</div>
                            <h3>Select or create a material</h3>
                            <p>Choose from the left panel or create a new one</p>
                        </div>
                    </div>
              </div>
                
                <div class="status-bar">
    <div class="api-status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">API Not Connected</span>
    </div>
    <span id="tokenCount">Ready</span>
    <span style="background: var(--primary-light); color: var(--primary-color); padding: 4px 12px; border-radius: 6px; font-size: 11px; font-weight: 500;">
        ‚å®Ô∏è Ctrl+Enter: Send to AI ‚Ä¢ Ctrl+Shift+Enter: Continue
    </span>
</div>
            </div>

            <!-- AI Settings Panel -->
<div class="ai-panel" id="aiPanel">
    <div class="ai-panel-tabs">
        <button class="ai-panel-tab active" onclick="switchAITab('settings')">‚öôÔ∏è Settings</button>
        <button class="ai-panel-tab" onclick="switchAITab('chat')">üí¨ Chat</button>
    </div>

    <!-- Settings View -->
    <div class="ai-panel-view active" id="settingsView">
        <div class="ai-panel-header">
            <h3>ü§ñ AI Assistant</h3>
        </div>
        <div class="ai-panel-content">
            <!-- Agent Selector (Optional Override) -->
            <div class="agent-selector">
                <label class="agent-selector-label">Use AI Agent (Optional)</label>
                <div class="agent-select-wrapper">
                    <select id="agentSelect" class="agent-select" onchange="switchAgent()">
                        <option value="">Manual Settings</option>
                    </select>
                    <button class="btn btn-small btn-outline" onclick="showAgentManager()">‚öôÔ∏è</button>
                </div>
                
                <!-- Configuration Selector (shows when agent selected) -->
                <div id="configSelector" style="display: none; margin-top: 10px;">
                    <label style="font-size: 11px; font-weight: 600; color: var(--primary-dark); display: block; margin-bottom: 5px;">MODEL CONFIGURATION</label>
                    <div style="display: flex; gap: 8px;">
                        <select id="configSelect" class="agent-select" onchange="switchConfiguration()" style="flex: 1;">
                            <option value="">Select configuration...</option>
                        </select>
                        <button class="btn btn-small btn-outline" onclick="manageConfigurations()" title="Manage configurations">‚öôÔ∏è</button>
                    </div>
                </div>
                
                <div class="agent-info-box" id="agentInfoBox" style="display: none;">
                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">
                        Active configuration will override manual settings
                    </div>
                    <div class="agent-info-row">
                        <span class="agent-info-label">Model:</span>
                        <span id="agentInfoModel">-</span>
                    </div>
                    <div class="agent-info-row">
                        <span class="agent-info-label">Temperature:</span>
                        <span id="agentInfoTemp">-</span>
                    </div>
                </div>
            </div>

            <!-- Model -->
            <div class="setting-group" id="modelGroup">
                <label class="setting-label">AI Model</label>
                <select id="modelSelect" class="setting-select" onchange="onModelChange()">
                    <option value="">Loading models...</option>
                </select>
                <button class="btn btn-outline" style="width: 100%; margin-top: 8px;" onclick="showModelManager()">
                    üìã Manage Models
                </button>
                <div id="modelInfo" style="font-size: 11px; color: var(--text-secondary); margin-top: 5px; display: none;">
                    <div id="modelPrice"></div>
                    <div id="modelContext"></div>
                </div>
            </div>

            <!-- Temperature -->
<div class="setting-group" id="temperatureGroup">
    <div style="display: flex; justify-content: space-between; align-items: center; gap: 15px;">
        <label class="setting-label" style="margin: 0; flex: 1;">Temperature</label>
        <input type="number" id="temperature" class="setting-input" 
               value="0.7" min="0" max="2" step="0.1" 
               onchange="saveSettings()"
               style="width: 100px; text-align: center;">
    </div>
    <div class="setting-help">
        Controls creativity (0 = deterministic, 2 = very creative)
    </div>
</div>

<!-- Top P -->
<div class="setting-group" id="topPGroup">
    <div style="display: flex; justify-content: space-between; align-items: center; gap: 15px;">
        <label class="setting-label" style="margin: 0; flex: 1;">Top P</label>
        <input type="number" id="topP" class="setting-input" 
               value="0.9" min="0" max="1" step="0.05" 
               onchange="saveSettings()"
               style="width: 100px; text-align: center;">
    </div>
    <div class="setting-help">
        Controls randomness (0 to 1)
    </div>
</div>

<!-- Max Tokens -->
<div class="setting-group" id="maxTokensGroup">
    <div style="display: flex; justify-content: space-between; align-items: center; gap: 15px;">
        <label class="setting-label" style="margin: 0; flex: 1;">Max Tokens</label>
        <input type="number" id="maxTokens" class="setting-input" 
               value="2000" min="100" max="8000" step="100" 
               onchange="saveSettings()"
               style="width: 100px; text-align: center;">
    </div>
    <div class="setting-help">
        Maximum length of response
    </div>
</div>

<!-- Frequency Penalty -->
<div class="setting-group" id="frequencyPenaltyGroup">
    <div style="display: flex; justify-content: space-between; align-items: center; gap: 15px;">
        <label class="setting-label" style="margin: 0; flex: 1;">Frequency Penalty</label>
        <input type="number" id="frequencyPenalty" class="setting-input" 
               value="0" min="0" max="2" step="0.1" 
               onchange="saveSettings()"
               style="width: 100px; text-align: center;">
    </div>
    <div class="setting-help">
        Reduces repetition. Higher = less repetition.
    </div>
</div>

<!-- Presence Penalty -->
<div class="setting-group" id="presencePenaltyGroup">
    <div style="display: flex; justify-content: space-between; align-items: center; gap: 15px;">
        <label class="setting-label" style="margin: 0; flex: 1;">Presence Penalty</label>
        <input type="number" id="presencePenalty" class="setting-input" 
               value="0" min="0" max="2" step="0.1" 
               onchange="saveSettings()"
               style="width: 100px; text-align: center;">
    </div>
    <div class="setting-help">
        Encourages new topics. Higher = more diverse.
    </div>
</div>

<!-- Repetition Penalty -->
<div class="setting-group" id="repetitionPenaltyGroup">
    <div style="display: flex; justify-content: space-between; align-items: center; gap: 15px;">
        <label class="setting-label" style="margin: 0; flex: 1;">Repetition Penalty</label>
        <input type="number" id="repetitionPenalty" class="setting-input" 
               value="1" min="0.5" max="2" step="0.05" 
               onchange="saveSettings()"
               style="width: 100px; text-align: center;">
    </div>
    <div class="setting-help">
        Penalizes repeating tokens. 1 = no penalty.
    </div>
</div>

    <!-- Chat View -->
    <div class="ai-panel-view" id="chatView">
        <!-- Chat Selector Header -->
        <div style="padding: 12px 20px; border-bottom: 1px solid var(--border-color); background: white;">
            <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 10px;">
                <select id="chatSelector" class="setting-select" onchange="switchChatFromDropdown()" style="flex: 1; padding: 8px; font-size: 13px;">
                    <option value="">Select a chat...</option>
                </select>
                <button class="btn btn-small btn-primary" onclick="createNewChat()" style="padding: 6px 12px; font-size: 13px;">+ New</button>
                <button class="icon-btn" onclick="showChatActionsMenu(event)" title="Chat actions" style="font-size: 18px;">‚ãÆ</button>
            </div>
        </div>
        
        <!-- Chat Actions Menu (hidden by default) -->
        <div class="context-menu" id="chatActionsMenu">
            <div class="context-menu-item" onclick="renameCurrentChat()">‚úèÔ∏è Rename Chat</div>
            <div class="context-menu-item" onclick="pinCurrentChat()">üìå Toggle Pin</div>
            <div class="divider"></div>
            <div class="context-menu-item" onclick="deleteCurrentChat()">üóëÔ∏è Delete Chat</div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="chat-empty">
                <div class="chat-empty-icon">üí¨</div>
                <h3>Start a Conversation</h3>
                <p>Ask questions, brainstorm ideas, or get feedback without affecting your documents</p>
            </div>
        </div>
        
        <div class="chat-input-area">
            <div class="chat-context-info" id="chatContextInfo">
                Context: No materials enabled
            </div>
            <div class="chat-input-wrapper">
                <textarea id="chatInput" class="chat-input" placeholder="Type your message..." rows="1"></textarea>
                <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">Send</button>
            </div>
            <div class="chat-actions">
                <button class="btn btn-small btn-outline" onclick="clearChat()">Clear Messages</button>
            </div>
        </div>
    </div>
    </div>
</div>
        </div>


    <!-- Modals -->
    
    <!-- New Category Modal -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Category</h2>
            </div>
            <div class="form-group">
                <label class="form-label">Category Name</label>
                <input type="text" id="categoryName" class="form-input" placeholder="e.g., Marketing, Creative Writing">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <input type="text" id="categoryDescription" class="form-input" placeholder="Brief description">
            </div>
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeModal('categoryModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createCategory()">Create</button>
            </div>
        </div>
    </div>

    <!-- New Project Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Project</h2>
            </div>
            <div class="form-group">
                <label class="form-label">Project Name</label>
                <input type="text" id="projectName" class="form-input" placeholder="e.g., Blog Posts, Ad Copy">
            </div>
            <div class="form-group">
                <label class="form-label">Category</label>
                <select id="projectCategory" class="form-select"></select>
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea id="projectDescription" class="form-textarea" placeholder="What is this project for?"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeModal('projectModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createProject()">Create</button>
            </div>
        </div>
    </div>

    <!-- Add Material Modal -->
<div class="modal" id="materialModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Add Material</h2>
        </div>
        <div class="form-group">
            <label class="form-label">Material Name</label>
            <input type="text" id="materialName" class="form-input" placeholder="e.g., Draft 1, Character Notes">
        </div>
        <div class="form-group">
            <label class="form-label">Content</label>
            <textarea id="materialContent" class="form-textarea" rows="10" placeholder="Enter your content here..."></textarea>
        </div>
        <div class="modal-actions">
            <button class="btn btn-outline" onclick="closeModal('materialModal')">Cancel</button>
            <button class="btn btn-primary" onclick="createMaterial()">Create</button>
        </div>
    </div>
</div>

    <!-- Upload File Modal -->
    <div class="modal" id="uploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Upload File</h2>
                <p style="color: var(--text-secondary); font-size: 14px;">Upload text files</p>
            </div>
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Click to browse or drag and drop</div>
                <div class="upload-subtext">Supports: .txt, .md, .pdf, .doc, .docx</div>
            </div>
            <input type="file" id="fileInput" style="display: none;" 
       accept=".txt,.md,.pdf,.doc,.docx" 
       onchange="handleFileSelect(event)">
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeModal('uploadModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
<div class="modal" id="settingsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">‚öôÔ∏è Settings</h2>
        </div>
        
        <div class="setting-group">
            <label class="setting-label">OpenRouter API Key</label>
            <input type="password" id="settingsApiKey" class="setting-input" 
                   placeholder="sk-or-...">
            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">
                Get your key from <a href="https://openrouter.ai/keys" target="_blank">OpenRouter.ai</a>
            </div>
        </div>

        <div class="setting-group">
            <label class="setting-label">Editor Font</label>
            <select id="settingsFont" class="setting-select" onchange="updateFontPreview()">
                <option value="system">System Default</option>
                <option value="georgia">Georgia (Serif)</option>
                <option value="times">Times New Roman (Serif)</option>
                <option value="palatino">Palatino (Serif)</option>
                <option value="garamond">Garamond (Serif)</option>
                <option value="arial">Arial (Sans-serif)</option>
                <option value="helvetica">Helvetica (Sans-serif)</option>
                <option value="verdana">Verdana (Sans-serif)</option>
                <option value="courier">Courier New (Monospace)</option>
                <option value="mono">Monaco (Monospace)</option>
            </select>
            <div class="font-preview" id="fontPreview">
                The quick brown fox jumps over the lazy dog
            </div>
        </div>

        <div class="modal-actions">
            <button class="btn btn-outline" onclick="closeModal('settingsModal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveSettingsModal()">Save Settings</button>
        </div>
    </div>
</div>

    <!-- Agent Manager Modal -->
    <div class="modal" id="agentManagerModal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2 class="modal-title">ü§ñ AI Agent Manager</h2>
                <p style="color: var(--text-secondary); font-size: 14px;">
                    Create and manage AI agents with custom settings and instructions
                </p>
            </div>

            <button class="btn btn-primary" style="margin-bottom: 20px;" onclick="showCreateAgentModal()">
                + Create New Agent
            </button>

            <div id="agentsList" style="max-height: 500px; overflow-y: auto;">
                <!-- Agents will be rendered here -->
            </div>

            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeModal('agentManagerModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Create/Edit Agent Modal -->
    <div class="modal" id="createAgentModal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2 class="modal-title" id="agentModalTitle">Create AI Agent</h2>
            </div>

            <div class="form-group">
                <label class="form-label">Agent Name</label>
                <input type="text" id="agentName" class="form-input" placeholder="e.g., Creative Writer, Technical Editor">
            </div>

            <div class="form-group">
                <label class="form-label">Description</label>
                <input type="text" id="agentDescription" class="form-input" placeholder="What is this agent specialized for?">
            </div>

            <div class="form-group">
                <label class="form-label">System Instructions</label>
                <textarea id="agentSystemPrompt" class="form-textarea" rows="6" 
                          placeholder="You are a helpful AI assistant that..."></textarea>
            </div>

            <div style="border-top: 2px solid var(--border-color); margin: 30px 0; padding-top: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">Model Configurations</h3>
                    <button class="btn btn-primary btn-small" onclick="addConfiguration()">+ Add Configuration</button>
                </div>
                
                <div id="configurationsList">
                    <!-- Configurations will render here -->
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeModal('createAgentModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveAgent()">Save Agent</button>
            </div>
        </div>
    </div>
    
    <!-- Configuration Edit Modal -->
    <div class="modal" id="configModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="configModalTitle">Add Configuration</h2>
            </div>
            
            <div class="form-group">
                <label class="form-label">Configuration Name</label>
                <input type="text" id="configName" class="form-input" placeholder="e.g., Claude Balanced, GPT Creative">
            </div>

            <div class="form-group">
                <label class="form-label">AI Model</label>
                <select id="configModel" class="form-select">
                    <option value="">Loading models...</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Temperature</label>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-size: 11px; color: var(--text-secondary);">Focused</span>
                    <span class="range-value" id="configTemperatureValue" style="margin: 0; font-size: 14px; font-weight: 600; color: var(--primary-color);">0.7</span>
                    <span style="font-size: 11px; color: var(--text-secondary);">Creative</span>
                </div>
                <input type="range" id="configTemperature" class="setting-range" 
                       min="0" max="1" step="0.05" value="0.7" 
                       oninput="updateConfigRangeDisplay('configTemperature')" style="width: 100%;">
            </div>

            <div class="form-group">
                <label class="form-label">Top P</label>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span class="range-value" id="configTopPValue" style="margin: 0; font-size: 14px; font-weight: 600; color: var(--primary-color);">0.9</span>
                </div>
                <input type="range" id="configTopP" class="setting-range" 
                       min="0" max="1" step="0.05" value="0.9" 
                       oninput="updateConfigRangeDisplay('configTopP')" style="width: 100%;">
            </div>

            <div class="form-group">
                <label class="form-label">Max Tokens</label>
                <input type="number" id="configMaxTokens" class="form-input" 
                       value="2000" min="100" max="8000">
            </div>

            <div class="form-group">
                <label class="form-label">Frequency Penalty</label>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span class="range-value" id="configFrequencyPenaltyValue" style="margin: 0; font-size: 14px; font-weight: 600; color: var(--primary-color);">0</span>
                </div>
                <input type="range" id="configFrequencyPenalty" class="setting-range" 
                       min="0" max="1" step="0.05" value="0" 
                       oninput="updateConfigRangeDisplay('configFrequencyPenalty')" style="width: 100%;">
            </div>

            <div class="form-group">
                <label class="form-label">Presence Penalty</label>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span class="range-value" id="configPresencePenaltyValue" style="margin: 0; font-size: 14px; font-weight: 600; color: var(--primary-color);">0</span>
                </div>
                <input type="range" id="configPresencePenalty" class="setting-range" 
                       min="0" max="1" step="0.05" value="0" 
                       oninput="updateConfigRangeDisplay('configPresencePenalty')" style="width: 100%;">
            </div>

            <div class="form-group">
                <label class="form-label">Repetition Penalty</label>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span class="range-value" id="configRepetitionPenaltyValue" style="margin: 0; font-size: 14px; font-weight: 600; color: var(--primary-color);">1</span>
                </div>
                <input type="range" id="configRepetitionPenalty" class="setting-range" 
                       min="0.5" max="1.5" step="0.05" value="1" 
                       oninput="updateConfigRangeDisplay('configRepetitionPenalty')" style="width: 100%;">
            </div>

            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeModal('configModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveConfiguration()">Save Configuration</button>
            </div>
        </div>
    </div>

    <!-- Prompt Library Modal -->
    <div class="modal" id="promptLibraryModal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2 class="modal-title">üìö Prompt Library</h2>
                <p style="color: var(--text-secondary); font-size: 14px;">
                    Reusable prompts for common tasks
                </p>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchPromptTab('browse')">Browse</button>
                <button class="tab" onclick="switchPromptTab('create')">Create New</button>
            </div>

            <!-- Browse Tab -->
            <div class="tab-content active" id="browsePromptsTab">
                <input type="text" id="promptSearch" class="model-search" 
                       placeholder="Search prompts..." oninput="filterPrompts()">

                <div id="promptsList" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                    <!-- Prompts will be rendered here -->
                </div>
            </div>

            <!-- Create Tab -->
            <div class="tab-content" id="createPromptTab">
                <div class="form-group">
                    <label class="form-label">Prompt Name</label>
                    <input type="text" id="promptName" class="form-input" 
                           placeholder="e.g., Fix Grammar, Summarize">
                </div>

                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select id="promptCategory" class="form-select">
                        <option value="writing">Writing</option>
                        <option value="editing">Editing</option>
                        <option value="analysis">Analysis</option>
                        <option value="creative">Creative</option>
                        <option value="technical">Technical</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Prompt Template</label>
                    <textarea id="promptTemplate" class="form-textarea" rows="8"
                              placeholder="Enter your prompt here. Use {content} as a placeholder for the current material."></textarea>
                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">
                        Tip: Use {content} to reference the current material
                    </div>
                </div>

                <button class="btn btn-primary" onclick="createPrompt()">Save Prompt</button>
            </div>

            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeModal('promptLibraryModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Model Manager Modal -->
    <div class="modal" id="modelManagerModal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2 class="modal-title">üìã Model Manager</h2>
                <p style="color: var(--text-secondary); font-size: 14px;">
                    Browse and manage available AI models from OpenRouter
                </p>
            </div>

            <input type="text" id="modelSearch" class="model-search" placeholder="Search models..." oninput="filterModels()">

            <div class="model-filters">
                <button class="filter-btn active" data-filter="all" onclick="setModelFilter('all')">All</button>
                <button class="filter-btn" data-filter="favorites" onclick="setModelFilter('favorites')">‚≠ê Favorites</button>
                <button class="filter-btn" data-filter="hidden" onclick="setModelFilter('hidden')">Hidden</button>
                <button class="filter-btn" onclick="refreshModels()">üîÑ Refresh</button>
            </div>

            <div class="models-list" id="modelsList">
                <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <div class="loading-spinner" style="margin: 0 auto 15px;"></div>
                    Loading models...
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeModal('modelManagerModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="renameMaterial()">Rename</div>
        <div class="context-menu-item" onclick="duplicateMaterial()">Duplicate</div>
        <div class="divider"></div>
        <div class="context-menu-item" onclick="deleteMaterial()">Delete</div>
    </div>

    <script>
        // Wait for Firebase to load
        let auth, db;
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCoT1IfgluPLXv8dYzSOwBJD-iEG9aV0So",
            authDomain: "ai-writing-hub.firebaseapp.com",
            projectId: "ai-writing-hub",
            storageBucket: "ai-writing-hub.firebasestorage.app",
            messagingSenderId: "486413916885",
            appId: "1:486413916885:web:94dea35a8440727d36e05c",
            measurementId: "G-Y2H81ND907"
        };

        // Initialize Firebase when scripts are loaded
        function initializeFirebase() {
            try {
                if (typeof firebase !== 'undefined') {
                    firebase.initializeApp(firebaseConfig);
                    auth = firebase.auth();
                    db = firebase.firestore();
                    setupAuthObserver();
                    console.log('Firebase initialized successfully');
                } else {
                    console.error('Firebase SDK not loaded');
                }
            } catch (error) {
                console.error('Firebase initialization error:', error);
            }
        }

        // Setup Auth State Observer
        function setupAuthObserver() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('authModal').classList.remove('visible');
                    renderUserProfile();
                    await loadUserData();
                    document.getElementById('syncStatus').style.display = 'flex';
                } else {
                    currentUser = null;
                    document.getElementById('authModal').classList.add('visible');
                    document.getElementById('syncStatus').style.display = 'none';
                    loadData(); // Load from localStorage as fallback
                }
                renderDashboard();
            });
        }

        // Global State
        let state = {
    categories: {},
    projects: {},
    materials: {},
    aiAgents: {},
    promptLibrary: {},
    chats: {}, // NEW: Store all chats
    currentChatId: null, // NEW: Track active chat
    currentProject: null,
    currentMaterial: null,
    currentAgent: null,
    recentProjects: [],
    availableModels: [],
    modelPreferences: {
        favorites: [],
        hidden: []
    },
    settings: {
        apiKey: '',
        model: 'anthropic/claude-3.5-sonnet',
        temperature: 0.7,
        topP: 0.9,
        maxTokens: 2000,
        font: 'system',
        frequencyPenalty: 0,
        presencePenalty: 0,
        repetitionPenalty: 1
    }
};

        let currentUser = null;
        let quillEditor = null;
        let currentModelFilter = 'all';
        let editingAgentId = null;
let lastAIRequest = null;
let autoSaveTimer = null;
        let firebaseSaveTimer = null;



        // Sign In / Sign Out
        async function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await auth.signInWithPopup(provider);
            } catch (error) {
                console.error('Sign in error:', error);
                alert('Sign in failed: ' + error.message);
            }
        }

        async function signOut() {
            try {
                await auth.signOut();
                // Clear local state but keep it in localStorage
                renderUserProfile();
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }

        function renderUserProfile() {
            const container = document.getElementById('userProfileContainer');
            
            if (currentUser) {
                container.innerHTML = `
                    <div class="user-profile" onclick="toggleUserMenu()">
                        <img src="${currentUser.photoURL || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><text y=%2220%22 font-size=%2220%22>üë§</text></svg>'}" 
                             alt="User" class="user-avatar">
                        <span class="user-name">${currentUser.displayName || 'User'}</span>
                    </div>
                    <div class="context-menu" id="userMenu" style="right: 40px; left: auto;">
                        <div class="context-menu-item" onclick="signOut()">Sign Out</div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <button class="sign-in-btn" onclick="signInWithGoogle()">
                        <svg width="18" height="18" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Sign In
                    </button>
                `;
            }
        }

        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            if (menu) {
                menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            }
        }

        // Firebase Data Management
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (userDoc.exists) {
                    const data = userDoc.data();
                    state = { ...state, ...data };
                    
                    // Validate and fix any issues
                    if (!state.settings.model) {
                        state.settings.model = 'anthropic/claude-3.5-sonnet';
                    }
                    if (state.currentAgent && !state.aiAgents[state.currentAgent]) {
                        state.currentAgent = null;
                    }
                    
                    updateSettingsUI();
                } else {
                    // First time user - initialize with defaults
                    await saveUserData();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                // Fall back to localStorage
                loadData();
            }
        }

        async function saveUserData() {
    if (!currentUser) {
        saveData(); // Save to localStorage as fallback
        return;
    }
    
    // Clear any existing timer
    if (firebaseSaveTimer) {
        clearTimeout(firebaseSaveTimer);
    }
    
    // Wait 3 seconds before actually saving to Firebase
    firebaseSaveTimer = setTimeout(async () => {
        try {
            await db.collection('users').doc(currentUser.uid).set(state);
            saveData(); // Also save to localStorage as backup
           console.log('‚úÖ Firebase sync complete at', new Date().toLocaleTimeString());
        } catch (error) {
            console.error('Error saving user data:', error);
            saveData(); // Fall back to localStorage
        }
    }, 3000); // Wait 3 seconds of inactivity before syncing
}

       // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Ensure at least one chat exists
    if (Object.keys(state.chats).length === 0) {
        const chatId = 'chat_' + Date.now();
        state.chats[chatId] = {
            id: chatId,
            name: 'General Chat',
            created: new Date().toISOString(),
            modified: new Date().toISOString(),
            messages: [],
            projectId: null,
            pinned: false,
            archived: false
        };
        state.currentChatId = chatId;
    } else if (!state.currentChatId) {
        // Set current chat to first available
        state.currentChatId = Object.keys(state.chats)[0];
    }
            // Initialize Firebase first
            initializeFirebase();
            
            setupEventListeners();
            updateApiStatus();
            loadModels();
            populateAgentSelector();
        });

        function setupEventListeners() {
    // Close context menu and export menu on click
    document.addEventListener('click', (e) => {
        // Close context menu
        document.getElementById('contextMenu').style.display = 'none';
        
        // Close user menu
        const userMenu = document.getElementById('userMenu');
        if (userMenu && !e.target.closest('.user-profile')) {
            userMenu.style.display = 'none';
        }

        // Close chat actions menu
        const chatActionsMenu = document.getElementById('chatActionsMenu');
        if (chatActionsMenu && !e.target.closest('[onclick*="showChatActionsMenu"]')) {
            chatActionsMenu.style.display = 'none';
        }
        
        // Close export menu if clicking outside
        const exportDropdown = document.querySelector('.export-dropdown');
        const exportMenu = document.getElementById('exportMenu');
        if (exportMenu && !exportDropdown?.contains(e.target)) {
            exportMenu.classList.remove('show');
        }
    });

    // File drag and drop
    const uploadArea = document.getElementById('uploadArea');
    if (uploadArea) {
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFileSelect({ target: { files: e.dataTransfer.files } });
        });
    }

    // ESC to close modals
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeAllModals();
            closeAIResponse();
        }
    });
    
    // Force save to Firebase when leaving the page
    window.addEventListener('beforeunload', async (e) => {
        if (currentUser && firebaseSaveTimer) {
            // Clear the timer and save immediately
            clearTimeout(firebaseSaveTimer);
            
            try {
                // Force immediate sync
                await db.collection('users').doc(currentUser.uid).set(state);
                console.log('‚úÖ Forced Firebase sync on page unload');
            } catch (error) {
                console.error('Error forcing save:', error);
            }
        }
    });
}

        // Data Management
        function loadData() {
            try {
                const saved = localStorage.getItem('aiWritingHub_v5');
                if (saved) {
                    const data = JSON.parse(saved);
                    state = { ...state, ...data };
                    
                    // Ensure settings exist
                    if (!state.settings.model) {
                        state.settings.model = 'anthropic/claude-3.5-sonnet';
                    }
                    if (state.settings.temperature === undefined) {
                        state.settings.temperature = 0.7;
                    }
                    if (state.settings.topP === undefined) {
                        state.settings.topP = 0.9;
                    }
                    if (state.settings.maxTokens === undefined) {
                        state.settings.maxTokens = 2000;
                    }
                    
                    // Validate currentAgent
                    if (state.currentAgent && !state.aiAgents[state.currentAgent]) {
                        state.currentAgent = null;
                    }
                    
                    updateSettingsUI();
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function saveData() {
            try {
                localStorage.setItem('aiWritingHub_v5', JSON.stringify(state));
                if (currentUser) {
                    saveUserData();
                }
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        // Model Management
        async function loadModels() {
            // Check cache
            const cachedModels = localStorage.getItem('openrouter_models_cache');
            const cacheTime = localStorage.getItem('openrouter_models_cache_time');
            const now = Date.now();
            
            if (cachedModels && cacheTime && (now - parseInt(cacheTime)) < 24 * 60 * 60 * 1000) {
                try {
                    state.availableModels = JSON.parse(cachedModels);
                    populateModelDropdowns();
                    console.log(`Loaded ${state.availableModels.length} models from cache`);
                    return;
                } catch (e) {
                    console.warn('Cache parse error, fetching fresh data');
                }
            }
            
            try {
                const headers = {
                    'Content-Type': 'application/json',
                    'HTTP-Referer': window.location.origin
                };
                
                if (state.settings.apiKey) {
                    headers['Authorization'] = `Bearer ${state.settings.apiKey}`;
                }
                
                const response = await fetch('https://openrouter.ai/api/v1/models', {
                    method: 'GET',
                    headers: headers
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Filter for text models only
                state.availableModels = data.data
                    .filter(model => {
                        const id = model.id.toLowerCase();
                        const name = model.name?.toLowerCase() || '';
                        
                        if (id.includes('vision') || id.includes('image') || 
                            id.includes('audio') || id.includes('whisper') ||
                            id.includes('dall-e') || id.includes('stable-diffusion') ||
                            name.includes('vision') || name.includes('image')) {
                            return false;
                        }
                        
                        return true;
                    })
                    .map(model => ({
                        id: model.id,
                        name: model.name || model.id,
                        description: model.description || '',
                        pricing: model.pricing || {},
                        context_length: model.context_length || 0,
                        architecture: model.architecture || {},
                        top_provider: model.top_provider || {}
                    }))
                    .sort((a, b) => a.name.localeCompare(b.name));

                localStorage.setItem('openrouter_models_cache', JSON.stringify(state.availableModels));
                localStorage.setItem('openrouter_models_cache_time', now.toString());

                populateModelDropdowns();
                
                console.log(`Loaded ${state.availableModels.length} text models from OpenRouter`);
            } catch (error) {
                console.error('Error loading models from API:', error);
                state.availableModels = getDefaultModels();
                populateModelDropdowns();
            }
        }

        function getDefaultModels() {
            return [
                { id: 'anthropic/claude-3.5-sonnet', name: 'Claude 3.5 Sonnet', description: 'Most intelligent model', pricing: { prompt: '0.000003', completion: '0.000015' }, context_length: 200000 },
                { id: 'anthropic/claude-3.5-haiku', name: 'Claude 3.5 Haiku', description: 'Fast and affordable', pricing: { prompt: '0.000001', completion: '0.000005' }, context_length: 200000 },
                { id: 'openai/gpt-4o', name: 'GPT-4o', description: 'OpenAI flagship model', pricing: { prompt: '0.0000025', completion: '0.00001' }, context_length: 128000 },
                { id: 'openai/gpt-4o-mini', name: 'GPT-4o Mini', description: 'Affordable GPT-4', pricing: { prompt: '0.00000015', completion: '0.0000006' }, context_length: 128000 },
                { id: 'google/gemini-pro-1.5', name: 'Gemini Pro 1.5', description: 'Google advanced model', pricing: { prompt: '0.00000125', completion: '0.000005' }, context_length: 2000000 },
                { id: 'meta-llama/llama-3.1-70b-instruct', name: 'Llama 3.1 70B', description: 'Balanced performance', pricing: { prompt: '0.00000035', completion: '0.0000004' }, context_length: 131072 }
            ];
        }

        function populateModelDropdowns() {
            const selects = [
                document.getElementById('modelSelect'),
                document.getElementById('agentModel')
            ];

            const visibleModels = state.availableModels.filter(m => 
                !state.modelPreferences.hidden.includes(m.id)
            );

            const sortedModels = visibleModels.sort((a, b) => {
                const aFav = state.modelPreferences.favorites.includes(a.id);
                const bFav = state.modelPreferences.favorites.includes(b.id);
                
                if (aFav && !bFav) return -1;
                if (!aFav && bFav) return 1;
                return a.name.localeCompare(b.name);
            });

            selects.forEach(select => {
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '';

                const favorites = sortedModels.filter(m => 
                    state.modelPreferences.favorites.includes(m.id)
                );
                
                if (favorites.length > 0) {
                    const favGroup = document.createElement('optgroup');
                    favGroup.label = '‚≠ê Favorites';
                    favorites.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.name;
                        favGroup.appendChild(option);
                    });
                    select.appendChild(favGroup);
                }

                const allGroup = document.createElement('optgroup');
                allGroup.label = favorites.length > 0 ? 'All Models' : 'Available Models';
                
                sortedModels.forEach(model => {
                    if (state.modelPreferences.favorites.includes(model.id)) return;
                    
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.name;
                    allGroup.appendChild(option);
                });
                select.appendChild(allGroup);

                if (currentValue && sortedModels.find(m => m.id === currentValue)) {
                    select.value = currentValue;
                } else if (select.id === 'modelSelect' && state.settings.model) {
                    select.value = state.settings.model;
                }
            });
        }

        function onModelChange() {
            state.settings.model = document.getElementById('modelSelect').value;
            saveData();
            updateModelInfo();
        }

        function saveSettings() {
    state.settings.model = document.getElementById('modelSelect').value;
    state.settings.temperature = parseFloat(document.getElementById('temperature').value);
    state.settings.topP = parseFloat(document.getElementById('topP').value);
    state.settings.maxTokens = parseInt(document.getElementById('maxTokens').value);
    state.settings.frequencyPenalty = parseFloat(document.getElementById('frequencyPenalty').value);
    state.settings.presencePenalty = parseFloat(document.getElementById('presencePenalty').value);
    state.settings.repetitionPenalty = parseFloat(document.getElementById('repetitionPenalty').value);
    saveData();
}

        function validateApiKey() {
    const key = document.getElementById('apiKey').value.trim();
    const hadKey = !!state.settings.apiKey;
    state.settings.apiKey = key;
    saveData();
    updateApiStatus();
    
    if (!hadKey && key && state.availableModels.length <= 15) {
        loadModels();
    }
}

        function updateModelInfo() {
            const modelId = state.settings.model;
            const model = state.availableModels.find(m => m.id === modelId);
            const infoDiv = document.getElementById('modelInfo');
            
            if (model && infoDiv) {
                const promptPrice = model.pricing.prompt ? `$${(parseFloat(model.pricing.prompt) * 1000000).toFixed(2)}/M` : 'N/A';
                const contextSize = model.context_length ? `${(model.context_length / 1000).toFixed(0)}K` : 'N/A';
                
                document.getElementById('modelPrice').textContent = `Input: ${promptPrice}`;
                document.getElementById('modelContext').textContent = `Context: ${contextSize} tokens`;
                infoDiv.style.display = 'block';
            } else if (infoDiv) {
                infoDiv.style.display = 'none';
            }
        }

        function showModelManager() {
            document.getElementById('modelManagerModal').style.display = 'flex';
            renderModelsList();
        }

        function renderModelsList() {
            const container = document.getElementById('modelsList');
            let models = [...state.availableModels];

            const searchTerm = document.getElementById('modelSearch')?.value.toLowerCase() || '';
            
            if (searchTerm) {
                models = models.filter(m => 
                    m.name.toLowerCase().includes(searchTerm) ||
                    m.id.toLowerCase().includes(searchTerm) ||
                    m.description.toLowerCase().includes(searchTerm)
                );
            }

            if (currentModelFilter === 'favorites') {
                models = models.filter(m => state.modelPreferences.favorites.includes(m.id));
            } else if (currentModelFilter === 'hidden') {
                models = models.filter(m => state.modelPreferences.hidden.includes(m.id));
            } else {
                models = models.filter(m => !state.modelPreferences.hidden.includes(m.id));
            }

            if (models.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 15px;">üîç</div>
                        <p>No models found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = models.map(model => {
                const isFavorite = state.modelPreferences.favorites.includes(model.id);
                const isHidden = state.modelPreferences.hidden.includes(model.id);
                const promptPrice = model.pricing.prompt ? `$${(parseFloat(model.pricing.prompt) * 1000000).toFixed(2)}/M tokens` : 'N/A';
                const completionPrice = model.pricing.completion ? `$${(parseFloat(model.pricing.completion) * 1000000).toFixed(2)}/M tokens` : 'N/A';
                
                return `
                    <div class="model-item ${isHidden ? 'hidden' : ''} ${isFavorite ? 'favorite' : ''}">
                        <div class="model-header">
                            <div class="model-name-block">
                                <div class="model-display-name">${model.name}</div>
                                <div class="model-id">${model.id}</div>
                            </div>
                            <div class="model-actions">
                                <button class="icon-btn" onclick="toggleFavorite('${model.id}')" title="${isFavorite ? 'Remove from favorites' : 'Add to favorites'}">
                                    ${isFavorite ? '‚≠ê' : '‚òÜ'}
                                </button>
                                <button class="icon-btn" onclick="toggleHidden('${model.id}')" title="${isHidden ? 'Show model' : 'Hide model'}">
                                    ${isHidden ? 'üëÅÔ∏è' : 'üö´'}
                                </button>
                            </div>
                        </div>
                        ${model.description ? `<p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 10px;">${model.description}</p>` : ''}
                        <div class="model-details">
                            <div class="model-detail">
                                <span class="detail-label">Context</span>
                                <span>${model.context_length ? (model.context_length / 1000).toFixed(0) + 'K tokens' : 'N/A'}</span>
                            </div>
                            <div class="model-detail">
                                <span class="detail-label">Input Price</span>
                                <span>${promptPrice}</span>
                            </div>
                            <div class="model-detail">
                                <span class="detail-label">Output Price</span>
                                <span>${completionPrice}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleFavorite(modelId) {
            const index = state.modelPreferences.favorites.indexOf(modelId);
            if (index > -1) {
                state.modelPreferences.favorites.splice(index, 1);
            } else {
                state.modelPreferences.favorites.push(modelId);
            }
            saveData();
            populateModelDropdowns();
            renderModelsList();
        }

        function toggleHidden(modelId) {
            const index = state.modelPreferences.hidden.indexOf(modelId);
            if (index > -1) {
                state.modelPreferences.hidden.splice(index, 1);
            } else {
                state.modelPreferences.hidden.push(modelId);
                const favIndex = state.modelPreferences.favorites.indexOf(modelId);
                if (favIndex > -1) {
                    state.modelPreferences.favorites.splice(favIndex, 1);
                }
            }
            saveData();
            populateModelDropdowns();
            renderModelsList();
        }

        function setModelFilter(filter) {
            currentModelFilter = filter;
            document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            renderModelsList();
        }

        function filterModels() {
            renderModelsList();
        }

        function refreshModels() {
            loadModels();
        }

        // Agent Management
        function populateAgentSelector() {
    const select = document.getElementById('agentSelect');
    if (!select) return;
    
    select.innerHTML = '<option value="">Manual Settings</option>';
    
    Object.values(state.aiAgents).forEach(agent => {
        const option = document.createElement('option');
        option.value = agent.id;
        option.textContent = agent.name;
        select.appendChild(option);
    });
    
    select.value = state.currentAgent || '';
    updateAgentUI();
}

        function switchAgent() {
    const select = document.getElementById('agentSelect');
    state.currentAgent = select.value || null;
    saveData();
    updateAgentUI();
    toggleManualSettings();
}

function switchConfiguration() {
    if (!state.currentAgent) return;
    
    const agent = state.aiAgents[state.currentAgent];
    if (!agent) return;
    
    const configSelect = document.getElementById('configSelect');
    agent.activeConfigId = configSelect.value;
    saveData();
    updateAgentInfo();
}

function toggleManualSettings() {
    const isManual = !state.currentAgent;
    const infoBox = document.getElementById('agentInfoBox');
    const groups = ['modelGroup', 'temperatureGroup', 'topPGroup', 'maxTokensGroup', 
                    'frequencyPenaltyGroup', 'presencePenaltyGroup', 'repetitionPenaltyGroup'];
    
    if (infoBox) {
        infoBox.style.display = isManual ? 'none' : 'block';
    }
    
    groups.forEach(groupId => {
        const group = document.getElementById(groupId);
        if (group) {
            group.style.opacity = isManual ? '1' : '0.5';
            group.style.pointerEvents = isManual ? 'auto' : 'none';
        }
    });
}

function updateAgentUI() {
    const configSelector = document.getElementById('configSelector');
    const configSelect = document.getElementById('configSelect');
    
    if (!state.currentAgent) {
        configSelector.style.display = 'none';
        document.getElementById('modelSelect').value = state.settings.model;
        document.getElementById('temperature').value = state.settings.temperature;
        document.getElementById('topP').value = state.settings.topP;
        document.getElementById('maxTokens').value = state.settings.maxTokens;
        updateRangeDisplay('temperature');
        updateRangeDisplay('topP');
        updateModelInfo();
        return;
    }
    
    const agent = state.aiAgents[state.currentAgent];
    if (!agent) return;
    
    // Show configuration selector if agent has configurations
    if (agent.configurations && agent.configurations.length > 0) {
        configSelector.style.display = 'block';
        
        configSelect.innerHTML = agent.configurations.map(config => 
            `<option value="${config.id}" ${config.id === agent.activeConfigId ? 'selected' : ''}>
                ${config.name}
            </option>`
        ).join('');
        
        // If no active config, select first one
        if (!agent.activeConfigId && agent.configurations.length > 0) {
            agent.activeConfigId = agent.configurations[0].id;
            saveData();
        }
    } else {
        configSelector.style.display = 'none';
    }
    
    updateAgentInfo();
}

function updateAgentInfo() {
    if (!state.currentAgent) return;
    
    const agent = state.aiAgents[state.currentAgent];
    if (!agent) return;
    
    // Get active configuration
    const activeConfig = agent.configurations?.find(c => c.id === agent.activeConfigId);
    
    if (activeConfig) {
        const model = state.availableModels.find(m => m.id === activeConfig.model);
        document.getElementById('agentInfoModel').textContent = model?.name || activeConfig.model;
        document.getElementById('agentInfoTemp').textContent = activeConfig.temperature;
    }
}

        function showAgentManager() {
            document.getElementById('agentManagerModal').style.display = 'flex';
            renderAgentsList();
        }

        function renderAgentsList() {
            const container = document.getElementById('agentsList');
            const agents = Object.values(state.aiAgents);
            
            if (agents.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ü§ñ</div>
                        <p>No agents yet. Create your first one!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = agents.map(agent => {
                const model = state.availableModels.find(m => m.id === agent.model);
                return `
                    <div class="agent-list-item">
                        <div class="agent-list-header">
                            <div>
                                <div class="agent-list-title">${agent.name}</div>
                                <div class="agent-list-description">${agent.description || 'No description'}</div>
                                <div class="agent-list-details">
                                    <span>Model: ${model?.name || agent.model}</span>
                                    <span>Temp: ${agent.temperature}</span>
                                    <span>Tokens: ${agent.maxTokens}</span>
                                </div>
                            </div>
                            <div class="agent-list-actions">
                                <button class="icon-btn" onclick="editAgent('${agent.id}')" title="Edit">‚úèÔ∏è</button>
                                <button class="icon-btn" onclick="deleteAgent('${agent.id}')" title="Delete">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showCreateAgentModal() {
            editingAgentId = null;
            document.getElementById('agentModalTitle').textContent = 'Create AI Agent';
            document.getElementById('agentName').value = '';
            document.getElementById('agentDescription').value = '';
            document.getElementById('agentModel').value = 'anthropic/claude-3.5-sonnet';
            document.getElementById('agentSystemPrompt').value = '';
            document.getElementById('agentTemperature').value = '0.7';
            document.getElementById('agentTopP').value = '0.9';
            document.getElementById('agentMaxTokens').value = '2000';
            updateAgentRangeDisplay('agentTemperature');
            updateAgentRangeDisplay('agentTopP');
            
            document.getElementById('createAgentModal').style.display = 'flex';
        }

        function editAgent(agentId) {
            const agent = state.aiAgents[agentId];
            if (!agent) return;
            
            editingAgentId = agentId;
            document.getElementById('agentModalTitle').textContent = 'Edit AI Agent';
            document.getElementById('agentName').value = agent.name;
            document.getElementById('agentDescription').value = agent.description || '';
            document.getElementById('agentModel').value = agent.model;
            document.getElementById('agentSystemPrompt').value = agent.systemPrompt || '';
            document.getElementById('agentTemperature').value = agent.temperature;
            document.getElementById('agentTopP').value = agent.topP;
            document.getElementById('agentMaxTokens').value = agent.maxTokens;
            updateAgentRangeDisplay('agentTemperature');
            updateAgentRangeDisplay('agentTopP');
            
            document.getElementById('createAgentModal').style.display = 'flex';
        }

        let editingConfigId = null;
let tempConfigurations = [];

function showCreateAgentModal() {
    editingAgentId = null;
    tempConfigurations = [];
    
    document.getElementById('agentModalTitle').textContent = 'Create AI Agent';
    document.getElementById('agentName').value = '';
    document.getElementById('agentDescription').value = '';
    document.getElementById('agentSystemPrompt').value = '';
    
    renderConfigurationsList();
    document.getElementById('createAgentModal').style.display = 'flex';
}

function editAgent(agentId) {
    const agent = state.aiAgents[agentId];
    if (!agent) return;
    
    editingAgentId = agentId;
    tempConfigurations = JSON.parse(JSON.stringify(agent.configurations || []));
    
    document.getElementById('agentModalTitle').textContent = 'Edit AI Agent';
    document.getElementById('agentName').value = agent.name;
    document.getElementById('agentDescription').value = agent.description || '';
    document.getElementById('agentSystemPrompt').value = agent.systemPrompt || '';
    
    renderConfigurationsList();
    document.getElementById('createAgentModal').style.display = 'flex';
}

function renderConfigurationsList() {
    const container = document.getElementById('configurationsList');
    
    if (tempConfigurations.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--text-secondary); background: var(--bg-color); border-radius: 8px;">
                <p>No configurations yet. Add at least one to get started.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = tempConfigurations.map((config, index) => {
        const model = state.availableModels.find(m => m.id === config.model);
        return `
            <div style="background: white; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 5px;">${config.name}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            ${model?.name || config.model} ‚Ä¢ Temp: ${config.temperature} ‚Ä¢ Tokens: ${config.maxTokens}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="icon-btn" onclick="editConfiguration(${index})" title="Edit">‚úèÔ∏è</button>
                        <button class="icon-btn" onclick="deleteConfiguration(${index})" title="Delete">üóëÔ∏è</button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function addConfiguration() {
    editingConfigId = null;
    
    document.getElementById('configModalTitle').textContent = 'Add Configuration';
    document.getElementById('configName').value = '';
    document.getElementById('configModel').value = state.availableModels[0]?.id || '';
    document.getElementById('configTemperature').value = '0.7';
    document.getElementById('configTopP').value = '0.9';
    document.getElementById('configMaxTokens').value = '2000';
    document.getElementById('configFrequencyPenalty').value = '0';
    document.getElementById('configPresencePenalty').value = '0';
    document.getElementById('configRepetitionPenalty').value = '1';
    
    updateConfigRangeDisplay('configTemperature');
    updateConfigRangeDisplay('configTopP');
    updateConfigRangeDisplay('configFrequencyPenalty');
    updateConfigRangeDisplay('configPresencePenalty');
    updateConfigRangeDisplay('configRepetitionPenalty');
    
    // Populate model dropdown
    const modelSelect = document.getElementById('configModel');
    modelSelect.innerHTML = state.availableModels
        .filter(m => !state.modelPreferences.hidden.includes(m.id))
        .map(m => `<option value="${m.id}">${m.name}</option>`)
        .join('');
    
    document.getElementById('configModal').style.display = 'flex';
}

function editConfiguration(index) {
    editingConfigId = index;
    const config = tempConfigurations[index];
    
    document.getElementById('configModalTitle').textContent = 'Edit Configuration';
    document.getElementById('configName').value = config.name;
    document.getElementById('configModel').value = config.model;
    document.getElementById('configTemperature').value = config.temperature;
    document.getElementById('configTopP').value = config.topP;
    document.getElementById('configMaxTokens').value = config.maxTokens;
    document.getElementById('configFrequencyPenalty').value = config.frequencyPenalty || 0;
    document.getElementById('configPresencePenalty').value = config.presencePenalty || 0;
    document.getElementById('configRepetitionPenalty').value = config.repetitionPenalty || 1;
    
    updateConfigRangeDisplay('configTemperature');
    updateConfigRangeDisplay('configTopP');
    updateConfigRangeDisplay('configFrequencyPenalty');
    updateConfigRangeDisplay('configPresencePenalty');
    updateConfigRangeDisplay('configRepetitionPenalty');
    
    // Populate model dropdown
    const modelSelect = document.getElementById('configModel');
    modelSelect.innerHTML = state.availableModels
        .filter(m => !state.modelPreferences.hidden.includes(m.id))
        .map(m => `<option value="${m.id}">${m.name}</option>`)
        .join('');
    
    document.getElementById('configModal').style.display = 'flex';
}

function deleteConfiguration(index) {
    if (!confirm('Delete this configuration?')) return;
    tempConfigurations.splice(index, 1);
    renderConfigurationsList();
}

function saveConfiguration() {
    const name = document.getElementById('configName').value.trim();
    const model = document.getElementById('configModel').value;
    
    if (!name || !model) {
        alert('Please enter a configuration name and select a model');
        return;
    }
    
    const config = {
        id: editingConfigId !== null ? tempConfigurations[editingConfigId].id : 'config_' + Date.now(),
        name,
        model,
        temperature: parseFloat(document.getElementById('configTemperature').value),
        topP: parseFloat(document.getElementById('configTopP').value),
        maxTokens: parseInt(document.getElementById('configMaxTokens').value),
        frequencyPenalty: parseFloat(document.getElementById('configFrequencyPenalty').value),
        presencePenalty: parseFloat(document.getElementById('configPresencePenalty').value),
        repetitionPenalty: parseFloat(document.getElementById('configRepetitionPenalty').value)
    };
    
    if (editingConfigId !== null) {
        tempConfigurations[editingConfigId] = config;
    } else {
        tempConfigurations.push(config);
    }
    
    renderConfigurationsList();
    closeModal('configModal');
}

function saveAgent() {
    const name = document.getElementById('agentName').value.trim();
    const description = document.getElementById('agentDescription').value.trim();
    const systemPrompt = document.getElementById('agentSystemPrompt').value.trim();
    
    if (!name) {
        alert('Please enter an agent name');
        return;
    }
    
    if (tempConfigurations.length === 0) {
        alert('Please add at least one configuration');
        return;
    }
    
    if (editingAgentId) {
        const agent = state.aiAgents[editingAgentId];
        agent.name = name;
        agent.description = description;
        agent.systemPrompt = systemPrompt;
        agent.configurations = tempConfigurations;
        
        // Ensure active config exists
        if (!agent.configurations.find(c => c.id === agent.activeConfigId)) {
            agent.activeConfigId = agent.configurations[0].id;
        }
    } else {
        const id = 'agent_' + Date.now();
        state.aiAgents[id] = {
            id,
            name,
            description,
            systemPrompt,
            configurations: tempConfigurations,
            activeConfigId: tempConfigurations[0].id
        };
    }
    
    saveData();
    populateAgentSelector();
    renderAgentsList();
    closeModal('createAgentModal');
}

function updateConfigRangeDisplay(id) {
    const value = document.getElementById(id).value;
    document.getElementById(id + 'Value').textContent = value;
}

function manageConfigurations() {
    if (!state.currentAgent) return;
    editAgent(state.currentAgent);
}

        // Prompt Library
        function showPromptLibrary() {
            document.getElementById('promptLibraryModal').style.display = 'flex';
            switchPromptTab('browse');
            renderPromptsList();
        }

        function switchPromptTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            
            if (tab === 'browse') {
                document.getElementById('browsePromptsTab').classList.add('active');
            } else {
                document.getElementById('createPromptTab').classList.add('active');
            }
        }

        function renderPromptsList() {
            const container = document.getElementById('promptsList');
            const prompts = Object.values(state.promptLibrary);
            
            if (prompts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìù</div>
                        <p>No prompts yet. Create your first one!</p>
                    </div>
                `;
                return;
            }
            
            const searchTerm = document.getElementById('promptSearch')?.value.toLowerCase() || '';
            const filtered = searchTerm ? 
                prompts.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) ||
                    p.category.toLowerCase().includes(searchTerm) ||
                    p.template.toLowerCase().includes(searchTerm)
                ) : prompts;
            
            container.innerHTML = filtered.map(prompt => `
                <div class="prompt-card">
                    <div class="prompt-card-header">
                        <div>
                            <div class="prompt-card-title">${prompt.name}</div>
                            <span class="prompt-card-category">${prompt.category}</span>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="icon-btn" onclick="editPrompt('${prompt.id}')" title="Edit">‚úèÔ∏è</button>
                            <button class="icon-btn" onclick="deletePrompt('${prompt.id}')" title="Delete">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="prompt-card-preview">${prompt.template}</div>
                    <div class="prompt-card-actions">
                        <button class="btn btn-small btn-primary" onclick="usePrompt('${prompt.id}')">Use This Prompt</button>
                    </div>
                </div>
            `).join('');
        }

        function createPrompt() {
            const name = document.getElementById('promptName').value.trim();
            const category = document.getElementById('promptCategory').value;
            const template = document.getElementById('promptTemplate').value.trim();
            
            if (!name || !template) {
                alert('Please enter a prompt name and template');
                return;
            }
            
            const id = 'prompt_' + Date.now();
            state.promptLibrary[id] = {
                id,
                name,
                category,
                template,
                created: new Date().toISOString()
            };
            
            saveData();
            
            // Clear form
            document.getElementById('promptName').value = '';
            document.getElementById('promptTemplate').value = '';
            
            // Switch back to browse tab
            switchPromptTab('browse');
            renderPromptsList();
        }

        function editPrompt(promptId) {
            // For now, just switch to create tab with values filled in
            const prompt = state.promptLibrary[promptId];
            if (!prompt) return;
            
            document.getElementById('promptName').value = prompt.name;
            document.getElementById('promptCategory').value = prompt.category;
            document.getElementById('promptTemplate').value = prompt.template;
            
            // Delete the old one
            delete state.promptLibrary[promptId];
            saveData();
            
            // Switch to create tab
            const tabs = document.querySelectorAll('.tab');
            tabs[1].click();
        }

        function deletePrompt(promptId) {
            const prompt = state.promptLibrary[promptId];
            if (!prompt) return;
            
            if (!confirm(`Delete prompt "${prompt.name}"?`)) return;
            
            delete state.promptLibrary[promptId];
            saveData();
            renderPromptsList();
        }

        async function usePrompt(promptId) {
            const prompt = state.promptLibrary[promptId];
            if (!prompt) return;
            
            if (!state.currentMaterial) {
                alert('Please select a material first');
                return;
            }
            
            // Get HTML content from Quill editor
            const htmlContent = quillEditor ? quillEditor.root.innerHTML : '';
            
            // Replace {content} with current material content
            const finalPrompt = prompt.template.replace(/{content}/g, htmlContent);
            
            closeModal('promptLibraryModal');
            
            // Send to AI
            let systemPrompt = 'You are a helpful AI assistant.';
            if (state.currentAgent && state.aiAgents[state.currentAgent]) {
                const agent = state.aiAgents[state.currentAgent];
                systemPrompt = agent.systemPrompt || systemPrompt;
            }
            
            lastAIRequest = { systemPrompt, context: finalPrompt };
            
            const btn = document.getElementById('sendBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Sending...';
            
            try {
                const response = await callOpenRouter(systemPrompt, finalPrompt);
                showAIResponse(response);
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üöÄ Send to AI';
            }
        }

        function filterPrompts() {
            renderPromptsList();
        }

        // Dashboard
        function renderDashboard() {
            const grid = document.getElementById('categoriesGrid');
            const emptyState = document.getElementById('emptyState');
            const continueSection = document.getElementById('continueSection');

            if (Object.keys(state.categories).length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                continueSection.style.display = 'none';
                return;
            }

            grid.style.display = 'grid';
            emptyState.style.display = 'none';
            grid.innerHTML = '';

            Object.values(state.categories).forEach(category => {
                const card = document.createElement('div');
                card.className = 'category-card';
                
                const categoryProjects = Object.values(state.projects)
                    .filter(p => p.categoryId === category.id);

                card.innerHTML = `
                    <div class="category-header">
                        <div class="category-name">${category.name}</div>
                        <div class="category-description">${category.description || ''}</div>
                    </div>
                    <div class="category-projects">
                        ${categoryProjects.length === 0 ? 
                            '<p style="color: var(--text-secondary); font-size: 13px; padding: 10px 0;">No projects yet</p>' :
                            categoryProjects.map(project => {
                                const materialCount = Object.values(state.materials)
                                    .filter(m => m.projectId === project.id).length;
                                return `
                                    <div class="project-item" onclick="openProject('${project.id}')">
                                        <div class="project-info">
                                            <div class="project-name">${project.name}</div>
                                            <div class="project-meta">${materialCount} materials</div>
                                        </div>
                                        <div class="project-icon">‚Üí</div>
                                    </div>
                                `;
                            }).join('')
                        }
                    </div>
                `;
                grid.appendChild(card);
            });

            renderRecentProjects();
        }

        function renderRecentProjects() {
            const container = document.getElementById('recentProjects');
            const section = document.getElementById('continueSection');
            
            if (state.recentProjects.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            container.innerHTML = '';

            state.recentProjects.slice(0, 3).forEach(projectId => {
                const project = state.projects[projectId];
                if (!project) return;

                const category = state.categories[project.categoryId];
                const materialCount = Object.values(state.materials)
                    .filter(m => m.projectId === project.id).length;

                const card = document.createElement('div');
                card.className = 'recent-project-card';
                card.onclick = () => openProject(project.id);
                card.innerHTML = `
                    <div class="recent-project-name">${project.name}</div>
                    <div class="recent-project-category">${category?.name || 'Unknown'}</div>
                    <div class="recent-project-meta">${materialCount} materials ‚Ä¢ Last opened ${formatDate(project.lastOpened)}</div>
                `;
                container.appendChild(card);
            });
        }

        // Category Management
        function showNewCategoryModal() {
            document.getElementById('categoryModal').style.display = 'flex';
            document.getElementById('categoryName').focus();
        }

        function createCategory() {
            const name = document.getElementById('categoryName').value.trim();
            const description = document.getElementById('categoryDescription').value.trim();

            if (!name) {
                alert('Please enter a category name');
                return;
            }

            const id = 'cat_' + Date.now();
            state.categories[id] = {
                id,
                name,
                description,
                created: new Date().toISOString()
            };

            saveData();
            renderDashboard();
            closeModal('categoryModal');

            document.getElementById('categoryName').value = '';
            document.getElementById('categoryDescription').value = '';
        }

        // Project Management
        function showNewProjectModal() {
            const select = document.getElementById('projectCategory');
            select.innerHTML = '<option value="">Select a category</option>';
            
            Object.values(state.categories).forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                select.appendChild(option);
            });

            document.getElementById('projectModal').style.display = 'flex';
            document.getElementById('projectName').focus();
        }

        function createProject() {
            const name = document.getElementById('projectName').value.trim();
            const categoryId = document.getElementById('projectCategory').value;
            const description = document.getElementById('projectDescription').value.trim();

            if (!name || !categoryId) {
                alert('Please enter a project name and select a category');
                return;
            }

            const id = 'proj_' + Date.now();
            state.projects[id] = {
                id,
                name,
                categoryId,
                description,
                created: new Date().toISOString(),
                lastOpened: new Date().toISOString()
            };

            saveData();
            renderDashboard();
            closeModal('projectModal');

            document.getElementById('projectName').value = '';
            document.getElementById('projectDescription').value = '';

            openProject(id);
        }

        function openProject(projectId) {
            const project = state.projects[projectId];
            if (!project) return;

            state.currentProject = project;
            project.lastOpened = new Date().toISOString();

            state.recentProjects = state.recentProjects.filter(id => id !== projectId);
            state.recentProjects.unshift(projectId);
            state.recentProjects = state.recentProjects.slice(0, 10);

            saveData();

            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('workspaceView').style.display = 'flex';

            const category = state.categories[project.categoryId];
            document.getElementById('sidebarProjectName').textContent = project.name;
document.getElementById('sidebarProjectCategory').textContent = category?.name || '';

            renderMaterials();
            updateEnabledCount();
            updateChatContextInfo();
        }

        function returnToDashboard() {
            state.currentProject = null;
            state.currentMaterial = null;
            quillEditor = null;
            document.getElementById('dashboardView').style.display = 'block';
            document.getElementById('workspaceView').style.display = 'none';
            renderDashboard();
        }

        // Material Management
        function showAddMaterialModal() {
            if (!state.currentProject) return;
            document.getElementById('materialModal').style.display = 'flex';
            document.getElementById('materialName').focus();
        }

        function createMaterial() {
    const name = document.getElementById('materialName').value.trim();
    const content = document.getElementById('materialContent').value;

    if (!name) {
        alert('Please enter a material name');
        return;
    }

    const id = 'mat_' + Date.now();
    state.materials[id] = {
        id,
        projectId: state.currentProject.id,
        name,
        type: 'draft', // Default type
        content,
        contentHtml: '', // For rich text
        enabled: true,
        created: new Date().toISOString(),
        modified: new Date().toISOString()
    };

    saveData();
    renderMaterials();
    closeModal('materialModal');

    document.getElementById('materialName').value = '';
    document.getElementById('materialContent').value = '';

    selectMaterial(id);
}

        function renderMaterials() {
            const container = document.getElementById('materialsList');
            const materials = Object.values(state.materials)
                .filter(m => m.projectId === state.currentProject.id)
                .sort((a, b) => new Date(b.modified) - new Date(a.modified));

            if (materials.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon" style="font-size: 32px;">üìÑ</div>
                        <p>No materials yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            materials.forEach(material => {
                const item = document.createElement('div');
                item.className = 'material-item' + (state.currentMaterial?.id === material.id ? ' selected' : '');
                item.dataset.materialId = material.id;
                
                item.innerHTML = `
                    <div class="material-toggle ${material.enabled ? 'enabled' : ''}" 
                         title="${material.enabled ? 'Enabled - will be sent to AI' : 'Disabled'}"></div>
                    <div class="material-info">
                        <div class="material-name" contenteditable="false">${material.name}</div>
                    </div>
                    <div class="material-actions">
                        <button class="delete-btn" title="Delete material">√ó</button>
                    </div>
                `;
                
                container.appendChild(item);
            });

            addMaterialEventListeners();
            updateEnabledCount();
        }

        function addMaterialEventListeners() {
            const items = document.querySelectorAll('.material-item');
            
            items.forEach(item => {
                const materialId = item.dataset.materialId;
                
                const deleteBtn = item.querySelector('.delete-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        deleteMaterialConfirm(materialId);
                    });
                }
                
                const toggle = item.querySelector('.material-toggle');
                if (toggle) {
                    toggle.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        toggleMaterial(materialId);
                    });
                }
                
                const nameElement = item.querySelector('.material-name');
                if (nameElement) {
                    nameElement.addEventListener('dblclick', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        startEditingMaterialName(materialId, nameElement);
                    });
                    
                    nameElement.addEventListener('blur', (e) => {
                        finishEditingMaterialName(materialId, nameElement);
                    });
                    
                    nameElement.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            nameElement.blur();
                        } else if (e.key === 'Escape') {
                            e.preventDefault();
                            nameElement.textContent = state.materials[materialId].name;
                            nameElement.contentEditable = 'false';
                            nameElement.classList.remove('editing');
                        }
                    });
                }
                
                const infoArea = item.querySelector('.material-info');
                if (infoArea) {
                    infoArea.addEventListener('click', (e) => {
                        const nameEl = item.querySelector('.material-name');
                        if (nameEl && nameEl.contentEditable === 'true') {
                            return;
                        }
                        e.preventDefault();
                        e.stopPropagation();
                        selectMaterial(materialId);
                    });
                }

                // Handle right-click for context menu
                item.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    showContextMenu(e, materialId);
                });
            });
        }

        // Context Menu
        function showContextMenu(event, materialId) {
            event.preventDefault();
            event.stopPropagation();
            
            window.contextMaterialId = materialId;
            
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'block';
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
        }

        function renameMaterial() {
            document.getElementById('contextMenu').style.display = 'none';
            
            const materialId = window.contextMaterialId;
            const material = state.materials[materialId];
            if (!material) return;
            
            const materialItem = document.querySelector(`[data-material-id="${materialId}"]`);
            if (materialItem) {
                const nameElement = materialItem.querySelector('.material-name');
                if (nameElement) {
                    startEditingMaterialName(materialId, nameElement);
                }
            }
        }

        function duplicateMaterial() {
            document.getElementById('contextMenu').style.display = 'none';
            
            const materialId = window.contextMaterialId;
            const material = state.materials[materialId];
            if (!material) return;
            
            const id = 'mat_' + Date.now();
            state.materials[id] = {
                ...material,
                id,
                name: material.name + ' (Copy)',
                created: new Date().toISOString(),
                modified: new Date().toISOString()
            };
            saveData();
            renderMaterials();
        }

        function deleteMaterial() {
            document.getElementById('contextMenu').style.display = 'none';
            
            const materialId = window.contextMaterialId;
            const material = state.materials[materialId];
            if (!material) return;
            
            if (confirm(`Delete "${material.name}"?`)) {
                delete state.materials[materialId];
                
                if (state.currentMaterial?.id === materialId) {
                    state.currentMaterial = null;
                    renderEditor();
                }
                
                saveData();
                renderMaterials();
            }
        }

        function startEditingMaterialName(materialId, nameElement) {
            nameElement.contentEditable = 'true';
            nameElement.classList.add('editing');
            nameElement.focus();
            
            const range = document.createRange();
            range.selectNodeContents(nameElement);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
        }

        function finishEditingMaterialName(materialId, nameElement) {
            const newName = nameElement.textContent.trim();
            const material = state.materials[materialId];
            
            if (!material) return;
            
            if (!newName) {
                nameElement.textContent = material.name;
            } else if (newName !== material.name) {
                material.name = newName;
                material.modified = new Date().toISOString();
                saveData();
                
                if (state.currentMaterial?.id === materialId) {
                    state.currentMaterial = material;
                    renderEditor();
                }
            }
            
            nameElement.contentEditable = 'false';
            nameElement.classList.remove('editing');
        }

function updateMaterialTitle() {
    if (!state.currentMaterial) return;
    
    const titleElement = document.getElementById('materialTitle');
    if (!titleElement) return;
    
    const newTitle = titleElement.textContent.trim();
    
    if (newTitle && newTitle !== state.currentMaterial.name) {
        state.currentMaterial.name = newTitle;
        state.currentMaterial.modified = new Date().toISOString();
        saveData();
        renderMaterials(); // Update sidebar to show new name
    } else if (!newTitle) {
        // Don't allow empty titles
        titleElement.textContent = state.currentMaterial.name;
    }
}
        
        function selectMaterial(materialId) {
            const material = state.materials[materialId];
            if (!material) return;

            state.currentMaterial = material;
            renderMaterials();
            renderEditor();
        }

        function renderEditor() {
    const card = document.getElementById('editorCard');
    
    if (!state.currentMaterial) {
        card.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon" style="font-size: 48px;">‚ú®</div>
                <h3>Select or create a material</h3>
                <p>Choose from the left panel or create a new one</p>
            </div>
        `;
        if (window.tinymce && window.tinymce.get('tinymceEditor')) {
            window.tinymce.get('tinymceEditor').remove();
        }
        return;
    }

    card.innerHTML = `
        <div style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                <div>
                    <h1 style="font-size: 32px; font-weight: 600; margin-bottom: 5px;" 
    contenteditable="true" 
    id="materialTitle"
    onblur="updateMaterialTitle()"
    onkeydown="if(event.key==='Enter'){event.preventDefault();this.blur();}">${state.currentMaterial.name}</h1>
                    <div style="font-size: 13px; color: var(--text-secondary);">Last edited: ${formatDate(state.currentMaterial.modified)}</div>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="btn btn-secondary btn-small" onclick="sendToAI()" id="sendBtn" disabled title="Send to AI (Ctrl/Cmd + Enter)">
                        üöÄ Send to AI
                    </button>
                    <button class="btn btn-primary btn-small" onclick="continueWriting()" id="continueBtn" disabled title="Continue Writing (Ctrl/Cmd + Shift + Enter)">
                        ‚úçÔ∏è Continue
                    </button>
                    <div class="export-dropdown">
                        <button class="btn btn-outline btn-small" onclick="toggleExportMenu()" id="exportBtn">
                            üì• Export
                        </button>
                        <div class="export-menu" id="exportMenu">
                            <div class="export-menu-item" onclick="exportMaterial('docx')">
                                üìÑ Word Document (.docx)
                            </div>
                            <div class="export-menu-item" onclick="exportMaterial('pdf')">
                                üìï PDF Document (.pdf)
                            </div>
                            <div class="export-menu-item" onclick="exportMaterial('txt')">
                                üìù Text File (.txt)
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="tinymceEditor"></div>
        
        <div class="ai-response-container" id="aiResponseContainer">
            <div class="ai-response-header">
                <div class="ai-response-title">
                    <span>ü§ñ</span>
                    <span>AI Response</span>
                </div>
                <div class="ai-response-actions">
                    <button class="icon-btn" onclick="closeAIResponse()" title="Close">√ó</button>
                </div>
            </div>
            <div class="ai-response-content" id="aiResponseContent"></div>
            <div class="ai-response-controls">
                <button class="btn btn-primary" onclick="acceptAIResponse('append')">
                    ‚úì Append to End
                </button>
                <button class="btn btn-primary" onclick="acceptAIResponse('replace')">
                    üîÑ Replace All
                </button>
                <button class="btn btn-outline" onclick="acceptAIResponse('insert')">
                    ‚Üì Insert at Cursor
                </button>
                <button class="btn btn-outline" onclick="retryAIRequest()">
                    üîÑ Retry
                </button>
                <button class="btn btn-outline" onclick="copyAIResponse()">
                    üìã Copy
                </button>
                <button class="btn btn-danger" onclick="closeAIResponse()">
                    ‚úï Reject
                </button>
            </div>
        </div>
    `;

    // Initialize TinyMCE
    initializeTinyMCE();
}

        function initializeTinyMCE() {
    // Remove existing instance if present
    if (window.tinymce && window.tinymce.get('tinymceEditor')) {
        window.tinymce.get('tinymceEditor').remove();
    }
    
    tinymce.init({
        selector: '#tinymceEditor',
        height: 600,
        menubar: false,
        resize: false,
        plugins: [
            'lists', 'link', 'charmap', 'anchor',
            'searchreplace', 'visualblocks', 'code', 'fullscreen',
            'table', 'wordcount'
        ],
        toolbar: 'undo redo | blocks | bold italic underline strikethrough | ' +
            'forecolor backcolor | alignleft aligncenter alignright alignjustify | ' +
            'bullist numlist | removeformat | code fullscreen',
        content_style: `
            body { 
                font-family: ${getFontFamily(state.settings.font)};
                font-size: 16px;
                line-height: 1.8;
                padding: 20px;
            }
        `,
        setup: function(editor) {
            editor.on('init', function() {
                // Load content
                if (state.currentMaterial.contentHtml) {
                    editor.setContent(state.currentMaterial.contentHtml);
                } else if (state.currentMaterial.content) {
                    const htmlContent = state.currentMaterial.content.replace(/\n/g, '<br>');
                    editor.setContent(htmlContent);
                }
                
                // Update API status
                updateApiStatus();
                updateTokenCount();
            });
            
            // Auto-save on change
            editor.on('change keyup', function() {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(() => {
                    autoSaveTinyMCE();
                }, 2000);
            });
            
            // Keyboard shortcuts
            editor.on('keydown', function(e) {
                // Ctrl/Cmd + Enter to send to AI
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendToAI();
                }
                
                // Ctrl/Cmd + Shift + Enter to continue writing
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'Enter') {
                    e.preventDefault();
                    continueWriting();
                }
            });
        }
    });
}

        function toggleMaterial(materialId) {
            const material = state.materials[materialId];
            if (material) {
                material.enabled = !material.enabled;
                saveData();
                renderMaterials();
            }
        }

        function toggleExportMenu() {
            const menu = document.getElementById('exportMenu');
            menu.classList.toggle('show');
        }

        async function exportMaterial(format) {
            document.getElementById('exportMenu').classList.remove('show');
            
            if (!state.currentMaterial) {
                alert('Please select a material to export');
                return;
            }

            const material = state.currentMaterial;
            const editor = tinymce.get('tinymceEditor');
const htmlContent = editor ? editor.getContent() : material.contentHtml || material.content;
            const plainContent = editor ? editor.getContent({format: 'text'}) : material.content;
            const filename = material.name.replace(/[^a-z0-9]/gi, '_').toLowerCase();

            try {
                switch (format) {
                    case 'txt':
                        exportAsText(plainContent, filename);
                        break;
                    case 'docx':
                        await exportAsWord(htmlContent, filename, material.name);
                        break;
                    case 'pdf':
                        await exportAsPDF(htmlContent, filename, material.name);
                        break;
                }
            } catch (error) {
                alert('Export error: ' + error.message);
            }
        }

        function exportAsText(content, filename) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename + '.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function exportAsWord(htmlContent, filename, title) {
            const fullHtml = `
                <!DOCTYPE html>
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'>
                <head>
                    <meta charset='utf-8'>
                    <title>${title}</title>
                    <style>
                        body { font-family: Calibri, sans-serif; font-size: 11pt; line-height: 1.5; }
                        h1 { font-size: 16pt; font-weight: bold; margin-bottom: 12pt; }
                        h2 { font-size: 14pt; font-weight: bold; margin-bottom: 10pt; }
                        h3 { font-size: 12pt; font-weight: bold; margin-bottom: 8pt; }
                        p { margin-bottom: 10pt; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    ${htmlContent}
                </body>
                </html>
            `;
            
            const blob = new Blob([fullHtml], { 
                type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' 
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename + '.docx';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function exportAsPDF(htmlContent, filename, title) {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset='utf-8'>
                    <title>${title}</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            font-size: 12pt; 
                            line-height: 1.6; 
                            margin: 40px;
                            max-width: 800px;
                        }
                        h1 { 
                            font-size: 18pt; 
                            font-weight: bold; 
                            margin-bottom: 20px;
                            border-bottom: 2px solid #333;
                            padding-bottom: 10px;
                        }
                        @media print {
                            body { margin: 20mm; }
                        }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    ${htmlContent}
                    <scr` + `ipt>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() { window.close(); }, 100);
                        };
                    </scr` + `ipt>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function autoSaveTinyMCE() {
    if (!state.currentMaterial) return;
    
    const editor = tinymce.get('tinymceEditor');
    if (!editor) return;

    state.currentMaterial.contentHtml = editor.getContent();
    state.currentMaterial.content = editor.getContent({format: 'text'});
    state.currentMaterial.modified = new Date().toISOString();
    saveData();
    updateTokenCount();
}
        
        function deleteMaterialConfirm(materialId) {
            const material = state.materials[materialId];
            if (!material) return;
            
            if (confirm(`Delete "${material.name}"?`)) {
                delete state.materials[materialId];
                
                if (state.currentMaterial?.id === materialId) {
                    state.currentMaterial = null;
                    renderEditor();
                }
                
                saveData();
                renderMaterials();
            }
        }

        // File Upload
        function showUploadModal() {
            document.getElementById('uploadModal').style.display = 'flex';
        }

        async function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    const uploadArea = document.getElementById('uploadArea');
    const originalHTML = uploadArea.innerHTML;
    uploadArea.innerHTML = `
        <div class="loading-spinner" style="margin: 20px auto;"></div>
        <div class="upload-text">Processing ${file.name}...</div>
    `;

    try {
        let content = '';
        const fileName = file.name.toLowerCase();
        
        if (fileName.endsWith('.txt') || fileName.endsWith('.md')) {
            // Plain text files
            content = await readFileContent(file);
        } else if (fileName.endsWith('.pdf')) {
            // Parse PDF
            content = await parsePDF(file);
        } else if (fileName.endsWith('.doc') || fileName.endsWith('.docx')) {
            // Parse Word document
            content = await parseWord(file);
        } else {
            throw new Error('Unsupported file type');
        }
        
        const id = 'mat_' + Date.now();
        
        state.materials[id] = {
            id,
            projectId: state.currentProject.id,
            name: file.name,
            type: 'draft',
            content,
            contentHtml: content.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>'),
            enabled: true,
            created: new Date().toISOString(),
            modified: new Date().toISOString()
        };

        saveData();
        renderMaterials();
        closeModal('uploadModal');
        selectMaterial(id);

        event.target.value = '';
    } catch (error) {
        alert('Error reading file: ' + error.message);
        uploadArea.innerHTML = originalHTML;
        event.target.value = '';
    }
}

async function parsePDF(file) {
    if (typeof pdfjsLib === 'undefined') {
        throw new Error('PDF library not loaded');
    }
    
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    
    let fullText = '';
    
    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        
        // Build text with better spacing
        let lastY = null;
        let pageText = '';
        
        textContent.items.forEach(item => {
            // Check if we're on a new line (Y coordinate changed significantly)
            if (lastY !== null && Math.abs(item.transform[5] - lastY) > 5) {
                pageText += '\n';
            }
            
            // Add space between words if needed
            if (pageText.length > 0 && !pageText.endsWith(' ') && !pageText.endsWith('\n')) {
                pageText += ' ';
            }
            
            pageText += item.str;
            lastY = item.transform[5];
        });
        
        fullText += pageText + '\n\n';
    }
    
    // Clean up excessive line breaks and spacing
    fullText = fullText
        .replace(/\n{3,}/g, '\n\n')  // Max 2 line breaks
        .replace(/ {2,}/g, ' ')       // Max 1 space between words
        .trim();
    
    return fullText;
}

async function parseWord(file) {
    if (typeof mammoth === 'undefined') {
        throw new Error('Word document library not loaded');
    }
    
    const arrayBuffer = await file.arrayBuffer();
    const result = await mammoth.extractRawText({ arrayBuffer });
    
    if (result.messages && result.messages.length > 0) {
        console.warn('Word parsing warnings:', result.messages);
    }
    
    return result.value;
}

        async function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('Failed to read file'));
                reader.readAsText(file);
            });
        }

        // AI Integration
        async function continueWriting() {
            if (!state.settings.apiKey) {
                alert('Please set your OpenRouter API key in Settings');
                return;
            }

            if (!state.currentMaterial || !quillEditor) {
                alert('Please select a material to continue writing');
                return;
            }

            const editor = tinymce.get('tinymceEditor');
if (!editor) {
    alert('Editor not ready');
    return;
}
const currentContent = editor.getContent({format: 'text'});
            if (!currentContent.trim()) {
                alert('Please write something first before continuing');
                return;
            }

            const btn = document.getElementById('continueBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Continuing...';

            try {
                let systemPrompt = 'You are a helpful AI writing assistant. Continue the writing naturally from where it left off.';
                
                if (state.currentAgent && state.aiAgents[state.currentAgent]) {
                    const agent = state.aiAgents[state.currentAgent];
                    systemPrompt = agent.systemPrompt || systemPrompt;
                }
                
                const userPrompt = `Continue writing from where this left off. Match the style and tone. Here's what I have so far:\n\n${currentContent}`;
                
                lastAIRequest = { systemPrompt, context: userPrompt };
                
                const response = await callOpenRouter(systemPrompt, userPrompt);
                showAIResponse(response);

            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function sendToAI() {
            if (!state.settings.apiKey) {
                alert('Please set your OpenRouter API key in Settings');
                return;
            }

            if (!state.currentMaterial) {
                alert('Please select a material first');
                return;
            }

            const enabledMaterials = Object.values(state.materials)
                .filter(m => m.projectId === state.currentProject.id && m.enabled);

            if (enabledMaterials.length === 0) {
                alert('Please enable at least one material to send to AI');
                return;
            }

            const btn = document.getElementById('sendBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Sending...';

            try {
                let context = '';
                enabledMaterials.forEach((m, i) => {
                    // Use HTML content if available, otherwise plain text
                    const content = m.contentHtml || m.content || '';
                    context += `\n\n--- ${m.name} (${m.type}) ---\n${content}`;
                });

                let systemPrompt = 'You are a helpful AI writing assistant.';
                
                if (state.currentAgent && state.aiAgents[state.currentAgent]) {
                    const agent = state.aiAgents[state.currentAgent];
                    systemPrompt = agent.systemPrompt || systemPrompt;
                }
                
                lastAIRequest = { systemPrompt, context };
                
                const response = await callOpenRouter(systemPrompt, context);
                showAIResponse(response);

            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üöÄ Send to AI';
            }
        }

        function showAIResponse(response) {
            const container = document.getElementById('aiResponseContainer');
            const content = document.getElementById('aiResponseContent');
            
            if (container && content) {
                content.textContent = response;
                container.classList.add('visible');
                window.currentAIResponse = response;
                container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function closeAIResponse() {
            const container = document.getElementById('aiResponseContainer');
            if (container) {
                container.classList.remove('visible');
                window.currentAIResponse = null;
            }
        }

        function acceptAIResponse(mode) {
    const response = window.currentAIResponse;
    if (!response || !state.currentMaterial) return;
    
    const editor = tinymce.get('tinymceEditor');
    if (!editor) return;

    const htmlResponse = markdownToHtml(response);
    
    switch (mode) {
        case 'append':
            const appendContent = editor.getContent() + '<br><br>' + htmlResponse;
            editor.setContent(appendContent);
            break;
            
        case 'replace':
            if (confirm('Replace all content with AI response?')) {
                editor.setContent(htmlResponse);
            } else {
                return;
            }
            break;
            
        case 'insert':
            editor.insertContent('<br><br>' + htmlResponse + '<br><br>');
            break;
    }

    autoSaveTinyMCE();
    closeAIResponse();
    editor.focus();
}

        async function retryAIRequest() {
            if (!lastAIRequest) {
                alert('No previous request to retry');
                return;
            }

            const btn = document.getElementById('sendBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Retrying...';

            try {
                const response = await callOpenRouter(lastAIRequest.systemPrompt, lastAIRequest.context);
                showAIResponse(response);
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üöÄ Send to AI';
            }
        }

        function copyAIResponse() {
            const response = window.currentAIResponse;
            if (!response) return;

            navigator.clipboard.writeText(response).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                alert('Failed to copy: ' + err.message);
            });
        }

        async function callOpenRouter(systemPrompt, userPrompt, agent) {
            // If no agent provided, use current agent or manual settings
            if (!agent) {
                if (state.currentAgent && state.aiAgents[state.currentAgent]) {
                    agent = state.aiAgents[state.currentAgent];
                } else {
                    // Use manual settings
                    agent = {
                        model: state.settings.model,
                        temperature: state.settings.temperature,
                        topP: state.settings.topP,
                        maxTokens: state.settings.maxTokens
                    };
                }
            }

            try {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.settings.apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'AI Writing Hub'
                    },
                    body: JSON.stringify({
    model: agent.model,
    messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: userPrompt }
    ],
    temperature: agent.temperature,
    top_p: agent.topP,
    max_tokens: agent.maxTokens,
    frequency_penalty: state.settings.frequencyPenalty || 0,
    presence_penalty: state.settings.presencePenalty || 0,
    repetition_penalty: state.settings.repetitionPenalty || 1
})
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    
                    let errorMessage = `HTTP ${response.status}`;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.error?.message || errorMessage;
                    } catch (e) {
                        errorMessage = response.statusText || errorMessage;
                    }
                    
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                
                if (!data.choices || !data.choices[0]) {
                    throw new Error('Invalid response format from API');
                }
                
                if (!data.choices[0].message || !data.choices[0].message.content) {
                    throw new Error('Invalid response format from API');
                }
                
                return data.choices[0].message.content;
            } catch (error) {
                throw error;
            }
        }

        // Settings
        function showSettings() {
    document.getElementById('settingsModal').style.display = 'flex';
    document.getElementById('settingsApiKey').value = state.settings.apiKey || '';
    document.getElementById('settingsFont').value = state.settings.font || 'system';
    updateFontPreview();
    document.getElementById('settingsApiKey').focus();
}

        function saveSettingsModal() {
    const hadKey = !!state.settings.apiKey;
    state.settings.apiKey = document.getElementById('settingsApiKey').value.trim();
    state.settings.font = document.getElementById('settingsFont').value;
    
    saveData();
    updateApiStatus();
    applyFont();
    
    if (state.currentProject) {
        updateSettingsUI();
    }
    
    if (!hadKey && state.settings.apiKey && state.availableModels.length <= 15) {
        loadModels();
    }
    
    closeModal('settingsModal');
}

        function validateApiKey() {
    const key = document.getElementById('apiKey').value.trim();
    const hadKey = !!state.settings.apiKey;
    state.settings.apiKey = key;
    saveData();
    updateApiStatus();
    
    if (!hadKey && key && state.availableModels.length <= 15) {
        loadModels();
    }
}

        function updateApiStatus() {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            const sendBtn = document.getElementById('sendBtn');
            const continueBtn = document.getElementById('continueBtn');

            if (state.settings.apiKey && state.settings.apiKey.startsWith('sk-or-')) {
                dot.classList.add('connected');
                text.textContent = 'API Connected ‚úì';
                if (sendBtn) sendBtn.disabled = false;
                if (continueBtn) continueBtn.disabled = false;
            } else {
                dot.classList.remove('connected');
                text.textContent = 'API Not Connected';
                if (sendBtn) sendBtn.disabled = true;
                if (continueBtn) continueBtn.disabled = true;
            }
        }

       function updateSettingsUI() {
    const apiKeyInput = document.getElementById('apiKey');
    const modelSelect = document.getElementById('modelSelect');
    const temperature = document.getElementById('temperature');
    const topP = document.getElementById('topP');
    const maxTokens = document.getElementById('maxTokens');
    const frequencyPenalty = document.getElementById('frequencyPenalty');
    const presencePenalty = document.getElementById('presencePenalty');
    const repetitionPenalty = document.getElementById('repetitionPenalty');
    
    if (apiKeyInput) apiKeyInput.value = state.settings.apiKey || '';
    if (modelSelect) modelSelect.value = state.settings.model;
    if (temperature) temperature.value = state.settings.temperature || 0.7;
    if (topP) topP.value = state.settings.topP || 0.9;
    if (maxTokens) maxTokens.value = state.settings.maxTokens || 2000;
    if (frequencyPenalty) frequencyPenalty.value = state.settings.frequencyPenalty || 0;
    if (presencePenalty) presencePenalty.value = state.settings.presencePenalty || 0;
    if (repetitionPenalty) repetitionPenalty.value = state.settings.repetitionPenalty || 1;
    
    updateModelInfo();
    updateApiStatus();
    toggleManualSettings();
}

        // Utilities
       function updateEnabledCount() {
    const count = Object.values(state.materials)
        .filter(m => m.projectId === state.currentProject.id && m.enabled).length;
    const el = document.getElementById('enabledCount');
    if (el) {
        el.textContent = `‚úì ${count} material${count !== 1 ? 's' : ''} enabled`;
        if (count > 0) {
            el.style.background = 'var(--secondary-color)';
        } else {
            el.style.background = 'var(--text-secondary)';
        }
    }
}

        function updateTokenCount() {
    const editor = tinymce.get('tinymceEditor');
    if (!editor) return;
    
    const text = editor.getContent({format: 'text'});
    const tokens = Math.ceil(text.length / 4);
    const el = document.getElementById('tokenCount');
    if (el) el.textContent = `${tokens} tokens ‚Ä¢ ${text.length} chars`;
}

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) return 'today';
            if (days === 1) return 'yesterday';
            if (days < 7) return `${days} days ago`;
            return date.toLocaleDateString();
        }

        // Modal Management
        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        }

        function updateFontPreview() {
    const font = document.getElementById('settingsFont').value;
    const preview = document.getElementById('fontPreview');
    preview.style.fontFamily = getFontFamily(font);
}

function getFontFamily(font) {
    const fonts = {
        'system': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
        'georgia': 'Georgia, serif',
        'times': '"Times New Roman", Times, serif',
        'palatino': '"Palatino Linotype", "Book Antiqua", Palatino, serif',
        'garamond': 'Garamond, serif',
        'arial': 'Arial, Helvetica, sans-serif',
        'helvetica': 'Helvetica, Arial, sans-serif',
        'verdana': 'Verdana, Geneva, sans-serif',
        'courier': '"Courier New", Courier, monospace',
        'mono': 'Monaco, "Lucida Console", monospace'
    };
    return fonts[font] || fonts['system'];
}

function applyFont() {
    const editor = tinymce.get('tinymceEditor');
    if (editor) {
        // TinyMCE handles fonts through content_style in init
        // Reinitialize if font changes
        initializeTinyMCE();
    }
}

        function switchAITab(tab) {
    document.querySelectorAll('.ai-panel-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.ai-panel-view').forEach(v => v.classList.remove('active'));
    
    event.target.classList.add('active');
    
    if (tab === 'settings') {
        document.getElementById('settingsView').classList.add('active');
    } else if (tab === 'chat') {
        document.getElementById('chatView').classList.add('active');
        updateChatContextInfo();
        renderChatSelector();
        renderChatMessages();
    }
}

function updateChatContextInfo() {
    if (!state.currentProject) return;
    
    const enabledMaterials = Object.values(state.materials)
        .filter(m => m.projectId === state.currentProject.id && m.enabled);
    
    const info = document.getElementById('chatContextInfo');
    if (enabledMaterials.length === 0) {
        info.textContent = 'Context: No materials enabled';
    } else {
        info.textContent = `Context: ${enabledMaterials.length} material${enabledMaterials.length !== 1 ? 's' : ''} enabled`;
    }
}

function renderChatMessages() {
    const container = document.getElementById('chatMessages');
    
    if (!state.currentChatId || !state.chats[state.currentChatId]) {
        if (Object.keys(state.chats).length === 0) {
            createNewChat();
            return;
        } else {
            state.currentChatId = Object.keys(state.chats)[0];
        }
    }
    
    const currentChat = state.chats[state.currentChatId];
    
    if (!currentChat.messages || currentChat.messages.length === 0) {
        container.innerHTML = `
            <div class="chat-empty">
                <div class="chat-empty-icon">üí¨</div>
                <h3>Start a Conversation</h3>
                <p>Ask questions, brainstorm ideas, or get feedback without affecting your documents</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = currentChat.messages.map((msg, index) => {
        const className = `chat-message ${msg.role}`;
        const actions = msg.role === 'assistant' ? `
            <div class="chat-message-actions">
                <button class="btn btn-small btn-outline" onclick="copyMessageToClipboard(${index})" style="padding: 4px 8px; font-size: 11px;">üìã Copy</button>
                <button class="btn btn-small btn-primary" onclick="sendMessageToDraft(${index})" style="padding: 4px 8px; font-size: 11px;">üìÑ To Draft</button>
            </div>
        ` : '';
        
        const formattedContent = msg.role === 'assistant' ? formatChatMessage(msg.content) : msg.content;

return `
    <div class="${className}">
        ${formattedContent}
        ${actions}
    </div>
`;
    }).join('');
    
    container.scrollTop = container.scrollHeight;
}

function formatChatMessage(content) {
    // Convert markdown-style formatting to HTML
    let formatted = content;
    
    // Escape any existing HTML to prevent issues
    formatted = formatted.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    
    // Headers: ## Header (do FIRST before other replacements)
    formatted = formatted.replace(/^### (.+)$/gm, '<h3 style="font-size: 14px; font-weight: 600; margin: 10px 0 5px 0;">$1</h3>');
    formatted = formatted.replace(/^## (.+)$/gm, '<h2 style="font-size: 15px; font-weight: 600; margin: 12px 0 6px 0;">$1</h2>');
    
    // Bold: **text** (do BEFORE italic)
    formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    
    // Italic: *text* (do AFTER bold)
    formatted = formatted.replace(/\*([^*]+)\*/g, '<em>$1</em>');
    
    // Bullet lists: - item or ‚Ä¢ item
    formatted = formatted.replace(/^[‚Ä¢-] (.+)$/gm, '<li style="margin-left: 20px;">$1</li>');
    
    // Wrap consecutive list items in ul tags
    formatted = formatted.replace(/(<li[^>]*>.*?<\/li>\s*)+/g, '<ul style="margin: 5px 0; padding-left: 10px;">$&</ul>');
    
    // Paragraphs: double line breaks
    formatted = formatted.replace(/\n\n/g, '</p><p style="margin: 8px 0;">');
    
    // Single line breaks
    formatted = formatted.replace(/\n/g, '<br>');
    
    // Wrap in paragraph tags
    if (!formatted.startsWith('<')) {
        formatted = '<p style="margin: 0;">' + formatted + '</p>';
    }
    
    return formatted;
}
        
async function sendChatMessage() {
    if (!state.settings.apiKey) {
        alert('Please set your OpenRouter API key in Settings');
        return;
    }
    
    if (!state.currentChatId || !state.chats[state.currentChatId]) {
        createNewChat();
    }
    
    const currentChat = state.chats[state.currentChatId];
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    currentChat.messages.push({
        role: 'user',
        content: message
    });
    
    currentChat.modified = new Date().toISOString();
    
    input.value = '';
    renderChatMessages();
    renderChatSelector();
    
    const btn = document.getElementById('chatSendBtn');
    btn.disabled = true;
    btn.textContent = 'Sending...';
    
    try {
        let context = '';
        
        if (state.currentProject) {
            const enabledMaterials = Object.values(state.materials)
                .filter(m => m.projectId === state.currentProject.id && m.enabled);
            
            if (enabledMaterials.length > 0) {
                context = 'Here is the context from enabled materials:\n\n';
                enabledMaterials.forEach(m => {
                    const content = m.contentHtml || m.content || '';
                    context += `--- ${m.name} (${m.type}) ---\n${content}\n\n`;
                });
            }
        }
        
        const fullMessage = context ? `${context}\n\nUser message: ${message}` : message;
        
        let systemPrompt = 'You are a helpful AI assistant. Provide clear, concise answers.';
        let agentConfig = null;
        
        if (state.currentAgent && state.aiAgents[state.currentAgent]) {
            const agent = state.aiAgents[state.currentAgent];
            systemPrompt = agent.systemPrompt || systemPrompt;
            
            // Get active configuration
            const activeConfig = agent.configurations?.find(c => c.id === agent.activeConfigId) || agent.configurations?.[0];
            if (activeConfig) {
                agentConfig = activeConfig;
            }
        }
        
        const response = await callOpenRouter(systemPrompt, fullMessage, agentConfig);
        
        currentChat.messages.push({
            role: 'assistant',
            content: response
        });
        
        currentChat.modified = new Date().toISOString();
        saveData();
        renderChatMessages();
        renderChatSelector();
        
    } catch (error) {
        alert('Error: ' + error.message);
        currentChat.messages.pop();
        renderChatMessages();
    } finally {
        btn.disabled = false;
        btn.textContent = 'Send';
        input.focus();
    }
}

// Chat Management Functions
function createNewChat() {
    const chatId = 'chat_' + Date.now();
    const chatName = prompt('Name this chat (optional):') || 'Untitled Chat';
    
    state.chats[chatId] = {
        id: chatId,
        name: chatName,
        created: new Date().toISOString(),
        modified: new Date().toISOString(),
        messages: [],
        projectId: state.currentProject?.id || null,
        pinned: false,
        archived: false
    };
    
    state.currentChatId = chatId;
    saveData();
    renderChatSidebar();
    renderChatMessages();
    updateChatHeader();
}

function switchChat(chatId) {
    state.currentChatId = chatId;
    saveData();
    renderChatMessages();
    updateChatHeader();
    
    // Update active state in sidebar
    document.querySelectorAll('.chat-list-item').forEach(item => {
        item.classList.toggle('active', item.dataset.chatId === chatId);
    });
}

function renameChat(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;
    
    const newName = prompt('Rename chat:', chat.name);
    if (newName && newName.trim()) {
        chat.name = newName.trim();
        chat.modified = new Date().toISOString();
        saveData();
        renderChatSidebar();
        updateChatHeader();
    }
}

function deleteChat(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;
    
    if (!confirm(`Delete chat "${chat.name}"?`)) return;
    
    delete state.chats[chatId];
    
    // If deleting current chat, switch to another or create new
    if (state.currentChatId === chatId) {
        const remainingChats = Object.keys(state.chats);
        if (remainingChats.length > 0) {
            state.currentChatId = remainingChats[0];
        } else {
            // Create a default chat
            createNewChat();
            return;
        }
    }
    
    saveData();
    renderChatSidebar();
    renderChatMessages();
    updateChatHeader();
}

function pinChat(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;
    
    chat.pinned = !chat.pinned;
    chat.modified = new Date().toISOString();
    saveData();
    renderChatSidebar();
}

function archiveChat(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;
    
    chat.archived = !chat.archived;
    chat.modified = new Date().toISOString();
    
    // If archiving current chat, switch to another
    if (state.currentChatId === chatId && chat.archived) {
        const activeChats = Object.values(state.chats).filter(c => !c.archived);
        if (activeChats.length > 0) {
            state.currentChatId = activeChats[0].id;
        } else {
            createNewChat();
            return;
        }
    }
    
    saveData();
    renderChatSidebar();
    renderChatMessages();
    updateChatHeader();
}

function copyMessageToClipboard(messageIndex) {
    const currentChat = state.chats[state.currentChatId];
    if (!currentChat || !currentChat.messages[messageIndex]) return;
    
    const message = currentChat.messages[messageIndex];
    navigator.clipboard.writeText(message.content).then(() => {
        alert('Message copied to clipboard!');
    }).catch(err => {
        alert('Failed to copy: ' + err.message);
    });
}

function sendMessageToDraft(messageIndex) {
    const currentChat = state.chats[state.currentChatId];
    if (!currentChat || !currentChat.messages[messageIndex]) return;
    
    if (!state.currentProject) {
        alert('Please open a project first');
        return;
    }
    
    const message = currentChat.messages[messageIndex];
    const materialName = prompt('Name for new material:', 'From Chat - ' + currentChat.name);
    
    if (!materialName) return;
    
    const id = 'mat_' + Date.now();
    state.materials[id] = {
        id,
        projectId: state.currentProject.id,
        name: materialName.trim(),
        type: 'draft',
        content: message.content,
        contentHtml: message.content.replace(/\n/g, '<br>'),
        enabled: true,
        created: new Date().toISOString(),
        modified: new Date().toISOString()
    };
    
    saveData();
    renderMaterials();
    selectMaterial(id);
    
    // Switch to settings tab to show the draft
    switchAITab('settings');
    
    alert('Message sent to new draft!');
}

// Chat Management Functions
function createNewChat() {
    const chatName = prompt('Name this chat (optional):') || 'Untitled Chat';
    
    const chatId = 'chat_' + Date.now();
    state.chats[chatId] = {
        id: chatId,
        name: chatName.trim(),
        created: new Date().toISOString(),
        modified: new Date().toISOString(),
        messages: [],
        projectId: state.currentProject?.id || null,
        pinned: false,
        archived: false
    };
    
    state.currentChatId = chatId;
    saveData();
    renderChatSelector();
    renderChatMessages();
}

function switchChat(chatId) {
    state.currentChatId = chatId;
    saveData();
    renderChatMessages();
    renderChatSelector();
}

function switchChatFromDropdown() {
    const selector = document.getElementById('chatSelector');
    const chatId = selector.value;
    if (chatId) {
        switchChat(chatId);
    }
}

function renderChatSelector() {
    const selector = document.getElementById('chatSelector');
    if (!selector) return;
    
    const chats = Object.values(state.chats)
        .filter(chat => !chat.archived)
        .sort((a, b) => {
            if (a.pinned && !b.pinned) return -1;
            if (!a.pinned && b.pinned) return 1;
            return new Date(b.modified) - new Date(a.modified);
        });
    
    if (chats.length === 0) {
        selector.innerHTML = '<option value="">No chats yet - create one!</option>';
        return;
    }
    
    selector.innerHTML = chats.map(chat => {
        const messageCount = chat.messages.length;
        const pin = chat.pinned ? 'üìå ' : '';
        return `<option value="${chat.id}" ${chat.id === state.currentChatId ? 'selected' : ''}>
            ${pin}${chat.name} (${messageCount} messages)
        </option>`;
    }).join('');
}

function showChatActionsMenu(event) {
    event.stopPropagation();
    const menu = document.getElementById('chatActionsMenu');
    const rect = event.target.getBoundingClientRect();
    menu.style.display = 'block';
    menu.style.left = (rect.left - 150) + 'px';
    menu.style.top = (rect.bottom + 5) + 'px';
}

function renameCurrentChat() {
    document.getElementById('chatActionsMenu').style.display = 'none';
    if (!state.currentChatId) return;
    
    const chat = state.chats[state.currentChatId];
    if (!chat) return;
    
    const newName = prompt('Rename chat:', chat.name);
    if (newName && newName.trim()) {
        chat.name = newName.trim();
        chat.modified = new Date().toISOString();
        saveData();
        renderChatSelector();
    }
}

function pinCurrentChat() {
    document.getElementById('chatActionsMenu').style.display = 'none';
    if (!state.currentChatId) return;
    
    const chat = state.chats[state.currentChatId];
    if (!chat) return;
    
    chat.pinned = !chat.pinned;
    chat.modified = new Date().toISOString();
    saveData();
    renderChatSelector();
}

function deleteCurrentChat() {
    document.getElementById('chatActionsMenu').style.display = 'none';
    if (!state.currentChatId) return;
    
    const chat = state.chats[state.currentChatId];
    if (!chat) return;
    
    if (!confirm(`Delete chat "${chat.name}"?`)) return;
    
    delete state.chats[state.currentChatId];
    
    const remainingChats = Object.keys(state.chats).filter(id => !state.chats[id].archived);
    if (remainingChats.length > 0) {
        state.currentChatId = remainingChats[0];
    } else {
        createNewChat();
        return;
    }
    
    saveData();
    renderChatSelector();
    renderChatMessages();
}

function copyMessageToClipboard(messageIndex) {
    const currentChat = state.chats[state.currentChatId];
    if (!currentChat || !currentChat.messages[messageIndex]) return;
    
    const message = currentChat.messages[messageIndex];
    navigator.clipboard.writeText(message.content).then(() => {
        alert('Message copied to clipboard!');
    }).catch(err => {
        alert('Failed to copy: ' + err.message);
    });
}

function sendMessageToDraft(messageIndex) {
    const currentChat = state.chats[state.currentChatId];
    if (!currentChat || !currentChat.messages[messageIndex]) return;
    
    if (!state.currentProject) {
        alert('Please open a project first');
        return;
    }
    
    const message = currentChat.messages[messageIndex];
    const materialName = prompt('Name for new material:', 'From Chat - ' + currentChat.name);
    
    if (!materialName) return;
    
    const id = 'mat_' + Date.now();
    state.materials[id] = {
        id,
        projectId: state.currentProject.id,
        name: materialName.trim(),
        type: 'draft',
        content: message.content,
        contentHtml: message.content.replace(/\n/g, '<br>'),
        enabled: true,
        created: new Date().toISOString(),
        modified: new Date().toISOString()
    };
    
    saveData();
    renderMaterials();
    selectMaterial(id);
    switchAITab('settings');
    
    alert('Message sent to new draft!');
}

function clearChat() {
    const currentChat = state.chats[state.currentChatId];
    if (!currentChat) return;
    
    if (currentChat.messages.length === 0) return;
    
    if (confirm(`Clear all messages in "${currentChat.name}"?`)) {
        currentChat.messages = [];
        currentChat.modified = new Date().toISOString();
        saveData();
        renderChatMessages();
        renderChatSelector();
    }
}

        function markdownToHtml(markdown) {
    let html = markdown;
    
    // Headers
    html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
    html = html.replace(/^## (.*$)/gim, '<h2>$2</h2>');
    html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
    
    // Bold
    html = html.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
    html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    
    // Italic
    html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
    html = html.replace(/_(.+?)_/g, '<em>$1</em>');
    
    // Strikethrough
    html = html.replace(/~~(.+?)~~/g, '<s>$1</s>');
    
    // Line breaks
    html = html.replace(/\n/g, '<br>');
    
    // Lists
    html = html.replace(/^\* (.+)$/gim, '<li>$1</li>');
    html = html.replace(/^- (.+)$/gim, '<li>$1</li>');
    html = html.replace(/^(\d+)\. (.+)$/gim, '<li>$2</li>');
    
    return html;
}
    </script>
</body>
</html>
